import{p as e,r as h,z as L}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{w,t as b,m as _,$ as Q,c as C,k as v,W as U,a0 as S,x as F,a1 as Z,u as B}from"./QueryClientProvider-B0e4pmks.js";import{S as H,M as $,D as R,F as k}from"./Delete-B9-Ttheo.js";import{u as N,L as I,C as G}from"./RenderData-BJF09N81.js";import{u as P}from"./input-D3y1GKQf.js";import{c as z,f as J,a as g,u as X,F as T,g as Y,h as ee}from"./index.esm-C0DY_CMF.js";import{P as te,u as se}from"./PageLoader-DZP7-pmZ.js";import{I as j}from"./InputField-Bsv0isQJ.js";import{b as ne,P as ae}from"./Pencil-B49a0cmu.js";import{f as ie}from"./time-CDh3KrcT.js";import{M as re}from"./query-eic4WXM_.js";import{u as oe,e as le,W as ce,g as de,a as me,b as ue,c as pe,f as xe,P as he}from"./patient-jbYBUO7p.js";import{L as fe,C as ge}from"./label-DGCx3GxL.js";const{add:je,update:we,delete:ye}=_.success.appointment,{dayConflict:be,timeConflict:ve}=_.error.appointment,tt=async({search:t,date:n},a)=>{let s=w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).order("time",{ascending:!0});return n&&(s=s.eq("date",n)),t.trim().length>0&&(s=s.ilike("patients.name",`%${t}%`)),a?await s.abortSignal(a):await s},st=async({search:t,date:n,doctorId:a},s)=>{let i=w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).eq("doctor_id",a).order("time",{ascending:!0});return n&&(i=i.eq("date",n)),t.trim().length>0&&(i=i.ilike("patients.name",`%${t}%`)),s?await i.abortSignal(s):await i},Ce=async t=>await w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).eq("id",t).order("time",{ascending:!0}),Ne=async t=>{const n=await w.from("appointments").insert([t]).select("*"),{status:a,error:s}=n;if(!s)b.success(je);else throw a===409&&(b.dismiss(Q),s.message.includes("unique_day_time")?b.error(ve):b.error(be)),new Error(s.message,{cause:n})},Fe=async t=>{const{patient:n,...a}=t,s=await w.from("appointments").update(a).eq("id",t.id).select("*"),{error:i}=s;if(!i)b.success(we);else throw new Error(i.message,{cause:s})},Pe=async t=>{const n=await w.from("appointments").delete().eq("id",t).select("*"),{error:a}=n;if(!a)b.success(ye);else throw new Error(a.message,{cause:n})};function nt({children:t,className:n}){return e.jsx("div",{className:C("grid auto-rows-max grid-cols-[repeat(auto-fill,minmax(19rem,1fr))] gap-5 overflow-auto pe-2 max-sm:px-2",n),children:t})}var W=(t=>(t.APPOINTMENT="appointment",t.PATIENT="patient",t))(W||{});function V(){return e.jsx("div",{className:"p-5",children:e.jsx(te,{})})}const qe=z({patient_id:g().required(v),doctor_id:g().required(v).when("availableDays",([t],n)=>n.test({name:"doctor-availability",message:"لاتوجد مواعيد متاحة للطبيب المختار",test:a=>t?!!a&&(t==null?void 0:t.length)>0:!0})),date:g().required(v).when("availableDays",([t],n)=>{var a,s;return n.test({name:"date-availability",message:`مواعيد الطبيب أيام ${(s=(a=t==null?void 0:t.sort())==null?void 0:a.map(i=>U(i.toString())))==null?void 0:s.join(" ، ")} فقط`,test:i=>{if(!(t!=null&&t.length))return!0;const r=new Date(i).getDay();return t==null?void 0:t.includes(r)}})}).test({name:"not-before-today",test:t=>{const n=new Date(t);return!S(n)},message:"لا يمكن حجز موعد بتاريخ قديم"}),time:g().nullable(),availableDays:J()}),Ae={patient_id:"",date:"",doctor_id:"",time:null,availableDays:[]},Se=async()=>w.from("profiles").select("*").eq("role","doctor");function ke({patientName:t}){const{isFetching:n,data:a}=N({queryKey:["patients-select"],queryFn:()=>Se(),select:d=>d.data}),s=(a==null?void 0:a.map(d=>({label:d.name,value:`${d.id}`})))??[],{values:i,setFieldValue:m,setFieldError:r}=X(),c=i.doctor_id,{data:o,refetch:u,isFetching:x}=N({queryKey:["availability",c],queryFn:()=>ne(c),select:d=>d.data,enabled:!!c});h.useEffect(()=>{c&&u()},[u,c]);const l=h.useMemo(()=>o==null?void 0:o.map(d=>+d.day),[o]);h.useEffect(()=>{m("availableDays",l),r("date",void 0),r("time",void 0)},[l,r,m]);const p=!!c&&(l==null?void 0:l.length)===0,f=i.date;return e.jsxs(e.Fragment,{children:[e.jsx(j,{label:"اسم المريض",name:"patientId",value:t,defaultValue:t,disabled:!0,className:"[&>div>input]:!opacity-100"}),e.jsx(H,{options:s,label:"الطبيب",name:"doctor_id",isDisabled:n,placeholder:n?". . . جاري التحميل":"اختر طبيب"}),e.jsx(j,{label:"التاريخ",name:"date",type:"date",value:f,placeholder:"اختر تاريخ",disabled:x||p,min:ie(new Date)}),e.jsx(j,{label:"الوقت",name:"time",type:"time",step:900,disabled:x||p,optional:!0})]})}function E({setIsOpen:t,patientData:n,appointmentId:a}){const{isFetching:s,data:i,isError:m}=N({queryKey:["appointment",a],queryFn:()=>Ce(a??""),enabled:!!a,select:f=>{var d;return(d=f.data)==null?void 0:d[0]}}),r=a?i==null?void 0:i.patient:n,c=F(),{mutate:o,isPending:u}=P({mutationFn:a?Fe:Ne,onSuccess:()=>{c.invalidateQueries({queryKey:["appointments"]}),t(!1)}});if(s)return e.jsx(V,{});if(m)return e.jsx(I,{});const x=r==null?void 0:r.name,l=r==null?void 0:r.id,p=a?i:{...Ae,patient_id:l};return e.jsx(T,{initialValues:p,validationSchema:qe,onSubmit:f=>{const{availableDays:d,doctor:M,...q}=f;o(q)},enableReinitialize:!0,children:e.jsx($,{submitBtnLabel:a?"تعديل":"حجز",isSubmitting:u,children:e.jsx(ke,{patientName:x})})})}function Me({className:t}){return e.jsx("svg",{width:"27px",height:"27px",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:C("stroke-black",t),children:e.jsx("path",{d:"M12 7V12L9.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}function Oe({onClick:t,className:n}){return e.jsx("span",{onClick:t,className:C("text-sm font-semibold text-primary transition hover:text-secondary hover:underline hover:underline-offset-4",n),children:"حجز موعد"})}function Ee({yesCallBack:t,noCallBack:n,patientName:a,isDisabled:s}){return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-7",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3",children:[e.jsx("span",{className:"text-xl font-bold",children:"هل تريد إلغاء موعد"}),e.jsx("span",{className:"font-semibold text-primary",children:a})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("button",{disabled:s,className:"h-fit w-20 rounded-xl border border-secondary px-5 py-2 font-medium text-secondary transition hover:bg-secondary hover:text-white",onClick:t,children:"نعم"}),e.jsx("button",{disabled:s,className:"h-fit w-20 rounded-xl border border-foreground px-5 py-2 font-medium text-foreground transition hover:bg-foreground hover:text-white",onClick:n,children:"لا"})]})]})}function De({appointmentId:t,patientName:n}){const[a,s]=h.useState(!1),i=F(),{mutate:m,isPending:r}=P({mutationFn:Pe,onSuccess:()=>{s(!1),i.invalidateQueries({queryKey:["appointments"]})}});return e.jsx(re,{title:"إلغاء موعد",className:"h-fit w-11/12 overflow-hidden rounded-lg md:w-2/5 lg:w-[25.5rem]",isOpen:a,toggle:c=>s(c??!1),trigger:e.jsx("div",{className:"h-fit rounded-xl border border-secondary px-4 py-1.5 text-sm font-medium text-secondary transition hover:bg-secondary hover:text-white",children:"إلغاء"}),children:e.jsx(Ee,{yesCallBack:()=>m(t),noCallBack:()=>s(!1),patientName:n,isDisabled:r})})}const Le=z({name:g().required(v),age:ee().typeError("أرقام فقط").required(v).min(3,"العمر غير صحيح").max(120,"العمر غير صحيح"),address:g(),phone:g().typeError("أرقام فقط").required(v).matches(/^01[0-25]\d{8}$/,"رقم غير صحيح"),phone_has_whatsapp:Y()}),_e={name:"",age:"",address:"",phone:"",phone_has_whatsapp:!1};function Be({setIsOpen:t,patientId:n}){const{isFetching:a,isError:s,data:i}=N({queryKey:["patient",n],queryFn:()=>de(n??""),enabled:!!n}),m=F(),{mutate:r,isPending:c}=P({mutationFn:n?oe:le,onSuccess:()=>{t(!1),m.invalidateQueries({queryKey:["patients"]})}});if(a)return e.jsx(V,{});if(s)return e.jsx(I,{});const o=i==null?void 0:i.data;return e.jsx(T,{initialValues:n?o:_e,validationSchema:Le,onSubmit:u=>r(u),validateOnChange:!0,children:({values:u,errors:x})=>{const l=!!u.phone,p=x.phone??!1,f=l?!!p:!0;return e.jsx(e.Fragment,{children:e.jsxs($,{isSubmitting:c,submitBtnLabel:n?"تعديل":"إضافة",children:[e.jsx(j,{label:"الاسم",name:"name",autoFocus:!0}),e.jsx(j,{onKeyDown:Z,label:"العمر",name:"age",inputMode:"numeric"}),e.jsx($e,{label:"رقم الهاتف",name:"phone",onChange:()=>{},hasWhatsappDisabled:f}),e.jsx(j,{label:"العنوان",name:"address",optional:!0})]})})}})}function $e({label:t,name:n,hasWhatsappDisabled:a}){return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{inputMode:"numeric",pattern:"[0-9]*",label:t,name:n,className:"w-full flex-1"}),e.jsxs(fe,{htmlFor:`${n}_has_whatsapp`,className:"mt-2 flex items-center gap-1.5",children:[e.jsx(ce,{className:"max-sm:size-5"}),e.jsx(ge,{className:"max-sm:size-4",name:`${n}_has_whatsapp`,disabled:a})]})]})}const Ie=({className:t})=>e.jsx("svg",{width:"4",height:"16",viewBox:"0 0 4 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:C(t),children:e.jsx("path",{d:"M2 16C1.45 16 0.979167 15.8042 0.5875 15.4125C0.195833 15.0208 0 14.55 0 14C0 13.45 0.195833 12.9792 0.5875 12.5875C0.979167 12.1958 1.45 12 2 12C2.55 12 3.02083 12.1958 3.4125 12.5875C3.80417 12.9792 4 13.45 4 14C4 14.55 3.80417 15.0208 3.4125 15.4125C3.02083 15.8042 2.55 16 2 16ZM2 10C1.45 10 0.979167 9.80417 0.5875 9.4125C0.195833 9.02083 0 8.55 0 8C0 7.45 0.195833 6.97917 0.5875 6.5875C0.979167 6.19583 1.45 6 2 6C2.55 6 3.02083 6.19583 3.4125 6.5875C3.80417 6.97917 4 7.45 4 8C4 8.55 3.80417 9.02083 3.4125 9.4125C3.02083 9.80417 2.55 10 2 10ZM2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4Z",fill:"#343434"})});function ze({className:t}){return e.jsx("svg",{width:"27px",height:"27px",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg",className:C("",t),children:e.jsxs("g",{fill:"gray",children:[e.jsx("path",{d:"M8 16a8 8 0 0 1-8-8 8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8zm0-1a7 7 0 0 0 7-7 7 7 0 0 0-7-7 7 7 0 0 0-7 7 7 7 0 0 0 7 7z"}),e.jsx("path",{d:"M8 3.75c-.386 0-.69.124-.914.373A1.269 1.269 0 0 0 6.75 5c0 .336.112.628.336.877.224.249.528.373.914.373s.69-.124.914-.373c.224-.249.336-.541.336-.877 0-.336-.112-.628-.336-.877C8.69 3.874 8.386 3.75 8 3.75zM7 7v5h2V7z",fontFamily:"Ubuntu",fontWeight:"400",letterSpacing:"0",wordSpacing:"0"})]})})}function Te({patient:t}){const[n,a]=h.useState(!1),[s,i]=h.useState(!1),[m,r]=h.useState(!1),{userId:c,isDoctor:o,isNurse:u,isAdmin:x}=B(),l=h.useRef(null),p=t==null?void 0:t.id,f=t==null?void 0:t.name,d=F(),{mutate:M,isPending:q}=P({mutationFn:xe,onSuccess:()=>{r(!1),d.invalidateQueries({queryKey:["patients"]})}});h.useEffect(()=>{const y=()=>{var O;(O=l.current)==null||O.focus({preventScroll:!0}),a(!1)};return document.addEventListener("wheel",y),document.addEventListener("touchmove",y),()=>{document.removeEventListener("wheel",y),document.removeEventListener("touchmove",y)}},[]),se(()=>{n&&(a==null||a(!1))},[n]);const K=x||u||o&&c===(t==null?void 0:t.user_id);return e.jsxs(me,{open:n,onOpenChange:a,children:[e.jsxs("div",{className:"relative -m-1.5",children:[e.jsx(ue,{ref:l,className:"flex size-8 items-center justify-center rounded-full transition-all hover:bg-gray-50",children:e.jsx(Ie,{})}),e.jsxs(pe,{align:"end",className:"-mt-1 flex h-fit w-40 !animate-none flex-col overflow-hidden rounded-lg bg-white p-0 drop-shadow-md !duration-0",children:[o&&e.jsx(L,{to:`/patients/${p}`,children:e.jsx(A,{label:"تفاصيل",icon:e.jsx(ze,{className:"size-[22.5px]"})})}),K&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>i(!0),children:e.jsx(A,{label:"تعديل",icon:e.jsx(ae,{className:"-me-1 -ms-1 h-7 w-8"})})}),e.jsx(G,{isOpen:m,toggle:()=>r(y=>!y),title:"حذف مريض",trigger:e.jsx(A,{label:"حذف",icon:e.jsx(R,{className:"size-[22.5px] fill-red-600"})}),confirmCallBack:()=>M(p??""),cancelCallBack:()=>r(!1),isActionsDisabled:q,children:e.jsxs("p",{className:"text-lg font-semibold",children:["هل تريد حذف ملف  ",e.jsx("span",{className:"text-primary",children:f}),"  ؟"]})})]})]})]}),e.jsx(k,{title:"تعديل مريض",isOpen:s,setIsOpen:i,children:e.jsx(Be,{setIsOpen:i,patientId:p})})]})}const A=({label:t,icon:n})=>e.jsxs("span",{className:"flex items-center gap-2 px-2.5 py-2 text-sm transition-all hover:bg-gray-50",children:[n,t]});function D({PatientId:t}){return e.jsx(L,{to:`/patients/${t}`,className:"text-sm font-semibold text-primary transition-all hover:underline hover:underline-offset-4",children:"تفاصيل"})}function at(t){const[n,a]=h.useState(!1),{patient:s,variant:i}=t,m=(s==null?void 0:s.name)??"",r=(s==null?void 0:s.phone)??"",c=(s==null?void 0:s.phone_has_whatsapp)??!1,o=i===W.PATIENT,{isAdmin:u,isNurse:x}=B(),l=x||u,p=o&&l;return e.jsxs("div",{className:"group flex h-fit w-full flex-col gap-5 rounded-xl bg-white px-3 py-4 transition duration-200 hover:shadow-md max-sm:gap-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 max-lg:justify-center max-lg:gap-2",children:[e.jsx("div",{className:"flex flex-1 flex-col gap-1 text-foreground group-hover:text-primary",children:e.jsx("h4",{className:"h-10 text-sm font-bold lg:h-12 lg:text-base",children:m})}),!o&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[l?S(new Date(t.date))?null:e.jsx(k,{title:"تعديل موعد",isOpen:n,setIsOpen:a,trigger:e.jsx("span",{className:"inline-flex w-full self-start text-xs font-semibold text-primary transition-all hover:text-secondary hover:underline max-sm:text-xs",children:"تغيير"}),children:e.jsx(E,{setIsOpen:a,appointmentId:t.appointmentId})}):null,e.jsxs("div",{className:"-mb-1 flex items-center gap-1",children:[e.jsx("span",{style:{direction:"ltr"},className:"text-sm font-medium text-foreground",children:!o&&t.time?t.time:"--:--"}),e.jsx(Me,{className:"-me-0.5 size-5"})]})]}),p&&e.jsx(Te,{patient:s})]}),e.jsxs("div",{className:"flex items-end justify-between max-lg:gap-2",children:[e.jsx(he,{phone:r,hasWhatsapp:c}),o?null:l?S(new Date(t.date))?null:e.jsx(De,{appointmentId:t.appointmentId,patientName:(s==null?void 0:s.name)??""}):e.jsx(D,{PatientId:(s==null?void 0:s.id)??""}),o?l?e.jsx(k,{title:"حجز موعد",isOpen:n,setIsOpen:a,trigger:e.jsx(Oe,{onClick:()=>{}}),children:e.jsx(E,{setIsOpen:a,patientData:s??void 0})}):e.jsx(D,{PatientId:(s==null?void 0:s.id)??""}):null]})]})}export{nt as C,at as P,W as a,tt as b,Be as c,st as g};
