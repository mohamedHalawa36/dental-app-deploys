import{p as e,r as h,w as z}from"./chunk-PVWAREVJ-DAoB9U7O.js";import{i as D,j as $,u as H,R as Z,k as Q}from"./RenderData-Cpx19uRU.js";import{t as b,a4 as _,a5 as F,m as J,w as M,x as N,u as k,a3 as W,c as A}from"./QueryClientProvider-DG-6Wefb.js";import{M as X,S as G,D as Y,F as ee}from"./Delete-Cobl3GZJ.js";import{T as se}from"./Table-BPC9B64p.js";import{u as C}from"./input-NtjB160r.js";import{F as te,u as ae,f as re}from"./index.esm-C3qyIEbc.js";import{L as oe,C as ne}from"./label-BLwDZI7b.js";import{I as v}from"./InputField-LR6bDRZX.js";import{a as ie,i as ce,r as le,b as de}from"./schemas-Oj9bdcne.js";import{f as I,m as ue,c as me,o as B,j as pe,X as he}from"./X-rLYKka1K.js";import{C as P}from"./ConfirmModal-uHNjYk6w.js";import{u as fe}from"./usePageContext-BJVNnTHd.js";import"./query-Z6G1zk3n.js";import"./PageLoader-DuEVSZFo.js";import"./Modal-B1zsy0OV.js";import"./ChevronLeft-DXS22zhl.js";import"./button-fyov8jge.js";import"./PageContext-DlO4Xewe.js";import"./Input-CZuHQ65I.js";const{success:{user:{delete:xe,add:ge,activate:be,deActivate:ve}}}=J,we=async({search:a,signal:r})=>{let s=M.from("profiles").select("*");return a.trim().length>0&&(s=s.ilike("name",`%${a}%`)),r&&(s=s.abortSignal(r)),await s},ye=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({user_id:a})}),t=await s.json();if(!s.ok)throw b.error(_),new Error((t==null?void 0:t.error)||"Failed to delete user");return b.success(xe),t},je=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)}),t=await s.json();if(!s.ok)throw b.error(_),new F(t==null?void 0:t.error,s.status,t.code);return b.success(ge),t},ke=async(a,r)=>{const{error:s}=await M.from("profiles").update({is_active:a}).eq("id",r).select("");s||b.success(a?be:ve)},Ce=async({userId:a,password:r,token:s})=>{const t=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/reset-user-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({password:r,userId:a})}),o=await t.json();if(!t.ok)throw b.error(_),new F(o==null?void 0:o.error,t.status,o.code);return b.success("تم اعادة تعيين كلمة السر"),o};function Se({setIsOpen:a,usersEmails:r}){var c,d;const s=N(),t=(d=(c=k().authData)==null?void 0:c.session)==null?void 0:d.access_token,{mutate:o,isPending:l}=C({mutationFn:i=>je(i,t),onSuccess:()=>{a(!1),s.invalidateQueries({queryKey:["users"]})}});return e.jsx(te,{initialValues:ce,validationSchema:ie(r),onSubmit:i=>o(i),validateOnChange:!0,children:e.jsxs(X,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[e.jsx(v,{label:"الاسم",name:"name",autoFocus:!W()}),e.jsx(G,{label:"الوظيفة",name:"role",options:le,placeholder:"اختر الوظيفة"}),e.jsx(v,{label:"البريد الإلكتروني",name:"email",type:"email",inputMode:"email",autoComplete:"email",autoCapitalize:"none",spellCheck:!1}),e.jsx(v,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),e.jsxs(oe,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[e.jsxs("span",{children:["مسؤول ","(Admin)"]}),e.jsx(ne,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var S="Switch",[Ae,ss]=me(S),[_e,Ne]=Ae(S),O=h.forwardRef((a,r)=>{const{__scopeSwitch:s,name:t,checked:o,defaultChecked:l,required:c,disabled:d,value:i="on",onCheckedChange:f,form:m,...p}=a,[n,u]=h.useState(null),x=I(r,j=>u(j)),g=h.useRef(!1),w=n?m||!!n.closest("form"):!0,[y,L]=ue({prop:o,defaultProp:l??!1,onChange:f,caller:S});return e.jsxs(_e,{scope:s,checked:y,disabled:d,children:[e.jsx(B.button,{type:"button",role:"switch","aria-checked":y,"aria-required":c,"data-state":R(y),"data-disabled":d?"":void 0,disabled:d,value:i,...p,ref:x,onClick:pe(a.onClick,j=>{L(K=>!K),w&&(g.current=j.isPropagationStopped(),g.current||j.stopPropagation())})}),w&&e.jsx(T,{control:n,bubbles:!g.current,name:t,value:i,checked:y,required:c,disabled:d,form:m,style:{transform:"translateX(-100%)"}})]})});O.displayName=S;var E="SwitchThumb",U=h.forwardRef((a,r)=>{const{__scopeSwitch:s,...t}=a,o=Ne(E,s);return e.jsx(B.span,{"data-state":R(o.checked),"data-disabled":o.disabled?"":void 0,...t,ref:r})});U.displayName=E;var Pe="SwitchBubbleInput",T=h.forwardRef(({__scopeSwitch:a,control:r,checked:s,bubbles:t=!0,...o},l)=>{const c=h.useRef(null),d=I(c,l),i=D(s),f=$(r);return h.useEffect(()=>{const m=c.current;if(!m)return;const p=window.HTMLInputElement.prototype,u=Object.getOwnPropertyDescriptor(p,"checked").set;if(i!==s&&u){const x=new Event("click",{bubbles:t});u.call(m,s),m.dispatchEvent(x)}},[i,s,t]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:s,...o,tabIndex:-1,ref:d,style:{...o.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});T.displayName=Pe;function R(a){return a?"checked":"unchecked"}var q=O,Fe=U;const V=h.forwardRef(({className:a,...r},s)=>e.jsx(q,{className:A("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...r,ref:s,children:e.jsx(Fe,{className:A("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));V.displayName=q.displayName;function Me({userId:a,active:r,disabled:s}){const t=N(),[o,l]=h.useState(!1),[c,d]=h.useState(r),{mutate:i,isPending:f}=C({mutationFn:()=>ke(c,a),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),l(!1)}}),m=c?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return e.jsxs(e.Fragment,{children:[e.jsx(V,{disabled:s,checked:c,onCheckedChange:p=>{d(p),l(!0)}}),e.jsx(P,{toggle:()=>l(p=>!p),isOpen:o,isActionsDisabled:f,title:c?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>i(),cancelCallBack:()=>{l(!1),d(p=>!p)},children:e.jsxs("p",{children:["هل أنت متأكد من ",m," ؟"]})})]})}function Ie({userId:a}){var i;const r=N(),{authData:s}=k(),t=(i=s==null?void 0:s.session)==null?void 0:i.access_token,[o,l]=h.useState(!1),{mutate:c,isPending:d}=C({mutationFn:()=>ye(a,t),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),l(!1)}});return e.jsxs(P,{toggle:()=>l(f=>!f),isOpen:o,isActionsDisabled:d,title:"حذف مستخدم",trigger:e.jsx(Y,{className:"size-6 fill-red-600"}),confirmCallBack:()=>c(),cancelCallBack:()=>l(!1),confirmLabel:"حذف",children:[e.jsx("p",{children:"هل أنت متأكد؟"}),e.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد إيقاف الحساب مؤقتا يمكنك إلغاء تفعيل الحساب فقط"})]})}function Be({className:a}){return e.jsx("svg",{width:"27px",height:"27px",viewBox:"0 0 512 512",xmlns:"http://www.w3.org/2000/svg",className:A("fill-primary",a),children:e.jsxs("g",{id:"Change_password",children:[e.jsx("path",{d:"M464.4326,147.54a9.8985,9.8985,0,0,0-17.56,9.1406,214.2638,214.2638,0,0,1-38.7686,251.42c-83.8564,83.8476-220.3154,83.874-304.207-.0088a9.8957,9.8957,0,0,0-16.8926,7.0049v56.9a9.8965,9.8965,0,0,0,19.793,0v-34.55A234.9509,234.9509,0,0,0,464.4326,147.54Z"}),e.jsx("path",{d:"M103.8965,103.9022c83.8828-83.874,220.3418-83.8652,304.207-.0088a9.8906,9.8906,0,0,0,16.8926-6.9961v-56.9a9.8965,9.8965,0,0,0-19.793,0v34.55C313.0234-1.3556,176.0547,3.7509,89.9043,89.9012A233.9561,233.9561,0,0,0,47.5674,364.454a9.8985,9.8985,0,0,0,17.56-9.1406A214.2485,214.2485,0,0,1,103.8965,103.9022Z"}),e.jsx("path",{d:"M126.4009,254.5555v109.44a27.08,27.08,0,0,0,27,27H358.5991a27.077,27.077,0,0,0,27-27v-109.44a27.0777,27.0777,0,0,0-27-27H153.4009A27.0805,27.0805,0,0,0,126.4009,254.5555ZM328,288.13a21.1465,21.1465,0,1,1-21.1465,21.1464A21.1667,21.1667,0,0,1,328,288.13Zm-72,0a21.1465,21.1465,0,1,1-21.1465,21.1464A21.1667,21.1667,0,0,1,256,288.13Zm-72,0a21.1465,21.1465,0,1,1-21.1465,21.1464A21.1667,21.1667,0,0,1,184,288.13Z"}),e.jsx("path",{d:"M343.6533,207.756V171.7538a87.6533,87.6533,0,0,0-175.3066,0V207.756H188.14V171.7538a67.86,67.86,0,0,1,135.7208,0V207.756Z"})]})})}function Oe({userId:a}){const{authData:r}=k(),[s,t]=h.useState(!1),o=ae({initialValues:{password:"",confirm_password:""},validationSchema:de,onSubmit:({password:u})=>{var x;return p({userId:a,password:u,token:(x=r==null?void 0:r.session)==null?void 0:x.access_token})}}),{handleBlur:l,handleChange:c,handleSubmit:d,submitForm:i,values:f,resetForm:m}=o;h.useEffect(()=>{m()},[s,m]);const{mutate:p,isPending:n}=C({mutationFn:Ce,onSuccess:()=>t(!1)});return e.jsx(P,{toggle:()=>t(u=>!u),isOpen:s,isActionsDisabled:n,title:"إعادة تعيين كلمة السر",trigger:e.jsx("span",{title:"إعادة تعيين كلمة السر",children:e.jsx(Be,{})}),confirmCallBack:i,cancelCallBack:()=>t(!1),confirmLabel:"تأكيد",cancelLabel:"إلغاء",children:e.jsx(re,{value:o,children:e.jsxs("form",{onSubmit:d,className:"flex w-full flex-1 flex-col gap-3 overflow-auto px-1",children:[e.jsx(v,{className:"[&>div]:border-primary/50 [&>div]:transition",name:"password",label:"كلمة السر المؤقتة",type:"password",disabled:n,autoComplete:"one-time-code",value:f.password,onChange:c,onBlur:l}),e.jsx(v,{className:"[&>div]:border-primary/50 [&>div]:transition",name:"confirm_password",label:"تأكيد كلمة السر المؤقتة",type:"password",disabled:n,autoComplete:"one-time-code",value:f.confirm_password,onChange:c,onBlur:l})]})})})}const ts=z(function(){const{addNewOpen:r,setAddNewOpen:s,search:t}=fe(),{data:o,isFetching:l,isError:c}=H({queryKey:["users",t],queryFn:async({signal:n})=>we({search:t,signal:n})}),{userId:d}=k(),i=(o==null?void 0:o.data)??[],f=(i==null?void 0:i.length)===0,m=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:n})=>n.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:n})=>n.getValue("is_admin")?e.jsx(Q,{className:"stroke-green-600"}):e.jsx(he,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:n})=>{const u=n.getValue("is_admin"),x=n.getValue("is_active"),g=n.original.id;return e.jsx(Me,{disabled:u,active:x,userId:g})}},{header:"تعديل",cell:({row:n})=>{const u=n.original.id,x=n.original.is_admin,g=n.original.id,w=d===g;return e.jsx("div",{className:"flex items-center gap-2",children:!x&&e.jsxs(e.Fragment,{children:[!w&&e.jsx(Oe,{userId:g}),e.jsx(Ie,{userId:u})]})})}}],p=i.map(n=>n.email);return e.jsxs(e.Fragment,{children:[e.jsx(Z,{isEmpty:f,isFetching:l,isError:c,children:e.jsx(se,{data:i??[],columns:m})}),e.jsx(ee,{title:"إضافة مستخدم",isOpen:r,setIsOpen:s,children:e.jsx(Se,{usersEmails:p,setIsOpen:s})})]})});export{ts as default};
