import{p as e,r as m,w as V}from"./chunk-PVWAREVJ-BxidzAYn.js";import{M as Q,e as H,k as W,l as J,C as P,D as X,u as G,R as Y,F as Z,m as ee}from"./Delete-BV49miqS.js";import{t as b,a1 as F,a3 as se,m as q,_ as E,k as g,U as S,u as M,c as A}from"./QueryClientProvider-CpaEDLfv.js";import{T as te}from"./Table-nJTnw0QR.js";import{u as _}from"./Input-BQTR1Cbm.js";import{c as ae,a as y,f as re,F as ne,I as C}from"./index.esm-Byw2hdNi.js";import{L as oe,C as ie}from"./label-BlUaLuK7.js";import{g as O,n as ce,d as le,p as I,k as de,X as ue}from"./PageLoader-BLlO2V5b.js";import{u as me}from"./usePageContext-BzeP3yfr.js";import"./query-BNquh6RW.js";import"./button-wR3Oxyk4.js";const{success:{user:{delete:pe,add:he,activate:fe,deActivate:ge}}}=q,be=async()=>await E.from("profiles").select("*"),xe=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({user_id:a})}),t=await s.json();if(!s.ok)throw b.error(F),new Error((t==null?void 0:t.error)||"Failed to delete user");return b.success(pe),t},ve=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)}),t=await s.json();if(!s.ok)throw b.error(F),new se(t==null?void 0:t.error,s.status,t.code);return b.success(he),t},ye=async(a,r)=>{const{error:s}=await E.from("profiles").update({is_active:a}).eq("id",r).select("");s||b.success(a?fe:ge)},ke=a=>ae({email:y().email("البريد الإلكتروني غير صحيح").required(g).test({test:r=>!a.includes(r),message:q.error.user.emailExists}),password:y().min(6,"يجب أن لا تقل كلمة السر عن 6 حروف").required(g),name:y().required(g),is_admin:re().required(g),role:y().required(g).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),we={email:"",password:"",name:"",is_admin:!1,role:""},je=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function Ce({setIsOpen:a,usersEmails:r}){var n,c;const s=S(),t=(c=(n=M().authData)==null?void 0:n.session)==null?void 0:c.access_token,{mutate:d,isPending:i}=_({mutationFn:l=>ve(l,t),onSuccess:()=>{a(!1),s.invalidateQueries({queryKey:["users"]})}});return e.jsx(ne,{initialValues:we,validationSchema:ke(r),onSubmit:l=>d(l),validateOnChange:!0,children:e.jsxs(Q,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:i,children:[e.jsx(C,{label:"الاسم",name:"name",autoFocus:!0}),e.jsx(H,{label:"الوظيفة",name:"role",options:je,placeholder:"اختر الوظيفة"}),e.jsx(C,{label:"البريد الإلكتروني",name:"email"}),e.jsx(C,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),e.jsxs(oe,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[e.jsxs("span",{children:["مسؤول ","(Admin)"]}),e.jsx(ie,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var k="Switch",[Se,De]=le(k),[_e,Ne]=Se(k),T=m.forwardRef((a,r)=>{const{__scopeSwitch:s,name:t,checked:d,defaultChecked:i,required:n,disabled:c,value:l="on",onCheckedChange:p,form:o,...u}=a,[h,f]=m.useState(null),w=O(r,v=>f(v)),j=m.useRef(!1),N=h?o||!!h.closest("form"):!0,[x,D]=ce({prop:d,defaultProp:i??!1,onChange:p,caller:k});return e.jsxs(_e,{scope:s,checked:x,disabled:c,children:[e.jsx(I.button,{type:"button",role:"switch","aria-checked":x,"aria-required":n,"data-state":K(x),"data-disabled":c?"":void 0,disabled:c,value:l,...u,ref:w,onClick:de(a.onClick,v=>{D(z=>!z),N&&(j.current=v.isPropagationStopped(),j.current||v.stopPropagation())})}),N&&e.jsx(U,{control:h,bubbles:!j.current,name:t,value:l,checked:x,required:n,disabled:c,form:o,style:{transform:"translateX(-100%)"}})]})});T.displayName=k;var B="SwitchThumb",R=m.forwardRef((a,r)=>{const{__scopeSwitch:s,...t}=a,d=Ne(B,s);return e.jsx(I.span,{"data-state":K(d.checked),"data-disabled":d.disabled?"":void 0,...t,ref:r})});R.displayName=B;var Ae="SwitchBubbleInput",U=m.forwardRef(({__scopeSwitch:a,control:r,checked:s,bubbles:t=!0,...d},i)=>{const n=m.useRef(null),c=O(n,i),l=W(s),p=J(r);return m.useEffect(()=>{const o=n.current;if(!o)return;const u=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(u,"checked").set;if(l!==s&&f){const w=new Event("click",{bubbles:t});f.call(o,s),o.dispatchEvent(w)}},[l,s,t]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:s,...d,tabIndex:-1,ref:c,style:{...d.style,...p,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});U.displayName=Ae;function K(a){return a?"checked":"unchecked"}var L=T,Pe=R;const $=m.forwardRef(({className:a,...r},s)=>e.jsx(L,{className:A("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...r,ref:s,children:e.jsx(Pe,{className:A("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));$.displayName=L.displayName;function Fe({userId:a,active:r,disabled:s}){const t=S(),[d,i]=m.useState(!1),[n,c]=m.useState(r),{mutate:l,isPending:p}=_({mutationFn:()=>ye(n,a),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),i(!1)}}),o=n?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return e.jsxs(e.Fragment,{children:[e.jsx($,{disabled:s,checked:n,onCheckedChange:u=>{c(u),i(!0)}}),e.jsx(P,{toggle:()=>i(u=>!u),isOpen:d,isActionsDisabled:p,title:n?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>l(),cancelCallBack:()=>{i(!1),c(u=>!u)},children:e.jsxs("p",{children:["هل أنت متأكد من ",o," ؟"]})})]})}function qe({userId:a}){var l;const r=S(),{authData:s}=M(),t=(l=s==null?void 0:s.session)==null?void 0:l.access_token,[d,i]=m.useState(!1),{mutate:n,isPending:c}=_({mutationFn:()=>xe(a,t),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),i(!1)}});return e.jsxs(P,{toggle:()=>i(p=>!p),isOpen:d,isActionsDisabled:c,title:"حذف مستخدم",trigger:e.jsx(X,{className:"size-6 fill-red-600"}),confirmCallBack:()=>n(),cancelCallBack:()=>i(!1),confirmLabel:"حذف",children:[e.jsx("p",{children:"هل أنت متأكد؟"}),e.jsx("p",{className:"text-sm text-red-500",children:"سيتم حذف كل السجلات المرتبطة بهذا المستخدم  "}),e.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد الاحتفاظ بالسجلات يمكنك إلغاء تفعيل الحساب فقط"})]})}const ze=V(function(){const{addNewOpen:r,setAddNewOpen:s}=me(),{data:t,isFetching:d,isError:i}=G({queryKey:["users"],queryFn:be}),n=(t==null?void 0:t.data)??[],c=(n==null?void 0:n.length)===0,l=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:o})=>o.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:o})=>o.getValue("is_admin")?e.jsx(ee,{className:"stroke-green-600"}):e.jsx(ue,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:o})=>{const u=o.getValue("is_admin"),h=o.getValue("is_active"),f=o.original.id;return e.jsx(Fe,{disabled:u,active:h,userId:f})}},{header:"تعديل",cell:({row:o})=>{const u=o.original.id,h=o.original.is_admin;return e.jsx("div",{className:"flex items-center gap-1",children:!h&&e.jsx(qe,{userId:u})})}}],p=n.map(o=>o.email);return e.jsxs(e.Fragment,{children:[e.jsx(Y,{isEmpty:c,isFetching:d,isError:i,children:e.jsx(te,{data:n??[],columns:l})}),e.jsx(Z,{title:"إضافة مستخدم",isOpen:r,setIsOpen:s,children:e.jsx(Ce,{usersEmails:p,setIsOpen:s})})]})});export{ze as default};
