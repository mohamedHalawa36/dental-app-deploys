import{p as e,r as y,w as F}from"./chunk-PVWAREVJ-chYXeG9N.js";import{M as w,e as O,f as k,C as q,D as S,u as _,R as v,F as A,l as N}from"./Delete-DXHi6wY_.js";import{t as p,Y as j,m as M,V as P,P as u,O as b,u as x}from"./QueryClientProvider-BB__S0BV.js";import{T}from"./Table-CbTIDFAS.js";import{u as C}from"./Input-HuNY4RtI.js";import{c as U,a as d,d as I,F as K,I as f}from"./InputField-D0SKqu2T.js";import{L as $,C as B}from"./label-BHqIpG-7.js";import{X as E}from"./X-DgIwKaiU.js";import{P as D}from"./PageContext-BJHu0vOw.js";import"./query-KAiRs6BO.js";import"./useAttachBackBtn-DQ725eOh.js";import"./button-li-iAYcl.js";const{success:{user:{delete:V,add:z}}}=M,Q=async()=>await P.from("profiles").select("*"),L=async(r,t)=>{const a=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({user_id:r})}),s=await a.json();if(!a.ok)throw p.error(j),new Error((s==null?void 0:s.error)||"Failed to delete user");return p.success(V),s},R=async(r,t)=>{const a=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r)}),s=await a.json();if(!a.ok)throw p.error(j),new Error((s==null?void 0:s.error)||"Failed to create user");return p.success(z),s},J=U({email:d().email("البريد الإلكتروني غير صحيح").required(u),password:d().min(8,"يجب أن لا تقل كلمة السر عن 8 حروف").required(u),name:d().required(u),is_admin:I().required(u),role:d().required(u).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),W={email:"",password:"",name:"",is_admin:!1,role:""},X=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function Y({setIsOpen:r}){var o,n;const t=b(),a=(n=(o=x().authData)==null?void 0:o.session)==null?void 0:n.access_token,{mutate:s,isPending:l}=C({mutationFn:c=>R(c,a),onSuccess:()=>{r(!1),t.invalidateQueries({queryKey:["users"]})}});return e.jsx(K,{initialValues:W,validationSchema:J,onSubmit:c=>s(c),validateOnChange:!0,children:e.jsxs(w,{className:"gap-4",submitBtn:e.jsx(k,{label:"إضافة",disabled:l}),children:[e.jsx(f,{label:"الاسم",name:"name"}),e.jsx(O,{label:"الوظيفة",name:"role",options:X,placeholder:"اختر الوظيفة"}),e.jsx(f,{label:"البريد الإلكتروني",name:"email"}),e.jsx(f,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),e.jsxs($,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[e.jsxs("span",{children:["مسؤول ","(Admin)"]}),e.jsx(B,{className:"max-sm:size-4",name:"is_admin"})]})]})})}function G({userId:r}){var m;const t=b(),{authData:a}=x(),s=(m=a==null?void 0:a.session)==null?void 0:m.access_token,[l,o]=y.useState(!1),{mutate:n,isPending:c}=C({mutationFn:()=>L(r,s),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),o(!1)}});return e.jsx(q,{toggle:()=>o(i=>!i),isOpen:l,isActionsDisabled:c,title:"حذف مستخدم",trigger:e.jsx(S,{className:"size-6 fill-red-600"}),confirmCallBack:()=>n(),cancelCallBack:()=>o(!1),children:e.jsx("p",{children:"هل أنت متأكد من حذف هذا المستخدم"})})}const ue=F(function(){const{addNewOpen:t,setAddNewOpen:a}=y.useContext(D);x();const{data:s,isFetching:l,isError:o}=_({queryKey:["users"],queryFn:Q}),n=(s==null?void 0:s.data)??[],c=(n==null?void 0:n.length)===0,m=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:i})=>i.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"Admin",cell:({row:i})=>i.getValue("is_admin")?e.jsx(N,{className:"stroke-green-600"}):e.jsx(E,{className:"fill-red-600"})},{header:"تعديل",cell:({row:i})=>{const h=i.original.id,g=i.original.is_admin;return e.jsx("div",{className:"flex items-center gap-1",children:!g&&e.jsx(G,{userId:h})})}}];return e.jsxs(e.Fragment,{children:[e.jsx(v,{isEmpty:c,isFetching:l,isError:o,children:e.jsx(T,{data:n??[],columns:m})}),e.jsx(A,{title:"إضافة مستخدم",isOpen:t,setIsOpen:a,children:e.jsx(Y,{setIsOpen:a})})]})});export{ue as default};
