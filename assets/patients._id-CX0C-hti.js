import{r as d,p as e,w as T,y as U,z as H}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{C as W}from"./ChevronLeft-DQqe5Vbc.js";import{k as f,w as h,t as C,x as q,u as P,c as k}from"./QueryClientProvider-B0e4pmks.js";import{D as S}from"./Calendar-CLtPXGTc.js";import{c as G,a as b,e as J,F as z,d as E}from"./index.esm-C0DY_CMF.js";import{P as F}from"./PageLoader-DZP7-pmZ.js";import{D as _}from"./DatePicker-1vr-lRn_.js";import{B as p}from"./Button-CX5LaLF9.js";import{u as D}from"./input-D3y1GKQf.js";import{f as w}from"./time-CDh3KrcT.js";import{C as V,u as R,R as A}from"./RenderData-BJF09N81.js";import{P as X,g as Y}from"./patient-jbYBUO7p.js";import{P as Z}from"./PageContext-CweN0xE8.js";import"./button-D5cQVpE8.js";import"./query-eic4WXM_.js";const I=G({doctor_id:b().required(f),patient_id:b().required(f),date:J().required(f),note:b().required(f)}),ee=async t=>h.from("notes").select(`
      *,
      doctor:profiles(id,name)
    `).order("date",{ascending:!1}).eq("patient_id",t),se=async t=>{const a=await h.from("notes").insert([t]).select("*"),{error:r}=a;if(!r)C.success("تم إضافة الملاحظة");else throw new Error(r.message,{cause:a})},te=async t=>{const a=await h.from("notes").update(t).eq("id",t.id).select("*"),{error:r}=a;if(!r)C.success("تم تعديل ملاحظتك");else throw new Error(r.message,{cause:a})},ae=async t=>{const a=await h.from("notes").delete().eq("id",t).select("*"),{error:r}=a;if(!r)C.success("تم حذف الملاحظة");else throw new Error(r.message,{cause:a})};function re({noteId:t}){const a=q(),[r,o]=d.useState(!1),{mutate:s,isPending:n}=D({mutationFn:ae,onSuccess:()=>{a.invalidateQueries({queryKey:["notes"]})}});return e.jsx(V,{toggle:()=>o(i=>!i),isOpen:r,isActionsDisabled:n,title:"حذف ملاحظة",trigger:e.jsx("span",{className:"text-secondary transition-all hover:opacity-70",children:"حذف"}),confirmCallBack:()=>s(t),cancelCallBack:()=>o(!1),children:e.jsx("p",{children:"هل أنت متأكد من حذف الملاحظة"})})}function ne({id:t,date:a,note:r,doctor:o,patient_id:s}){const[n,i]=d.useState(!1),{userId:g}=P(),m=g===o.id,{mutate:x,isPending:y}=D({mutationFn:te,onSuccess:()=>{i(!1)}}),j=o.name,N=w(new Date(a)),u=d.useRef(null);return d.useEffect(()=>{if(!n)return;const l=u.current;if(l){l.focus();const c=l.value.length;l.setSelectionRange(c,c)}},[n]),e.jsx(z,{initialValues:{id:t,doctor_id:o.id,patient_id:s,date:N,note:r},validationSchema:I,onSubmit:l=>x(l),children:({values:l,setFieldValue:c,resetForm:B,dirty:K,isValid:L})=>{const{date:M,note:Q,id:$}=l,O=new Date(M);return e.jsxs(E,{className:"relative flex w-3/4 flex-col gap-3 max-lg:w-full",children:[y&&e.jsx(F,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-full flex-col gap-4 rounded-xl bg-white p-3 shadow-sm shadow-primary/40 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",j]})]}),e.jsx(_,{value:O,onChange:v=>c("date",v),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day",disabled:!n})]}),e.jsx("textarea",{rows:n?5:void 0,ref:u,placeholder:"اكتب ملاحظاتك هنا",className:k("rounded-xl border border-gray-200 bg-transparent p-2 text-left text-foreground transition-all placeholder:text-sm focus:outline-primary",{"resize-none":!n,"border border-gray-300":n}),name:"note",onChange:v=>c("note",v.target.value),value:Q,disabled:!n}),m?!n&&e.jsxs("div",{className:"-mt-1 flex items-center justify-end gap-2 text-sm font-semibold",children:[e.jsx("button",{className:"text-primary transition-all hover:opacity-70",onClick:()=>i(!0),children:"تعديل"}),e.jsx(re,{noteId:$})]}):null]}),n&&e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(p,{className:"w-20 p-2 text-sm",disabled:!L||!K,children:"حفظ"}),e.jsx(p,{variant:"secondary",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white",type:"button",onClick:()=>{B(),i(!1)},children:"إلغاء"})]})]})}})}function oe({className:t}){return e.jsx("div",{className:k("flex size-7 items-center justify-center rounded-full border-2 border-primary text-xl",t),children:"+"})}function ie({patientId:t}){const[a,r]=d.useState(!1),{userName:o,userId:s}=P(),n=q(),{mutate:i,isPending:g}=D({mutationFn:se,onSuccess:()=>{n.invalidateQueries({queryKey:["notes"]})}});return a?e.jsx(z,{initialValues:{doctor_id:s,patient_id:t,date:w(new Date),note:""},validationSchema:I,onSubmit:m=>i(m),children:({values:m,setFieldValue:x,isValid:y,dirty:j})=>{const{date:N}=m,u=new Date(N),l=new Date;return e.jsxs(E,{className:"relative flex w-full flex-col gap-3",children:[g&&e.jsx(F,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-full flex-col gap-4 rounded-xl border border-gray-300 border-primary/40 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",o]})]}),e.jsx(_,{value:u,onChange:c=>x("date",w(c??l)),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day"})]}),e.jsx("textarea",{placeholder:"اكتب ملاحظاتك هنا",className:"rounded-xl border border-gray-300 bg-transparent p-2 text-foreground transition-all placeholder:text-sm focus:outline-primary",name:"note",onChange:c=>x("note",c.target.value),rows:a?5:void 0})]}),e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(p,{className:"w-20 p-2 text-sm",type:"submit",disabled:!y||!j,children:"حفظ"}),e.jsx(p,{variant:"secondary",type:"button",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white",onClick:()=>r(!1),children:"إلغاء"})]})]})}}):e.jsxs("button",{onClick:()=>r(!0),className:"flex items-center gap-1.5 text-sm font-semibold text-primary hover:text-primary/80",children:[e.jsx(oe,{className:"size-5"}),"أضف ملاحظة"]})}function le({patientId:t}){const{isDoctor:a}=P(),{isError:r,isFetching:o,data:s}=R({queryKey:["notes",t],queryFn:()=>ee(t)}),n=s==null?void 0:s.data;return e.jsx(A,{isFetching:o,isError:r,isEmpty:!1,children:e.jsxs("div",{className:"flex flex-col items-start gap-4 overflow-auto px-5 py-4 max-sm:px-3 md:overflow-auto",children:[a&&e.jsx(ie,{patientId:t}),n==null?void 0:n.map(i=>d.createElement(ne,{...i,key:i.id}))]})})}function ce({patientId:t}){const{data:a,isFetching:r,isError:o}=R({queryKey:["patient",t],queryFn:()=>Y(t)}),s=a==null?void 0:a.data,n=!s;return e.jsx(A,{isFetching:r,isError:o,isEmpty:n,children:e.jsxs("div",{className:"max-sm flex flex-col gap-1 rounded-xl px-5 py-3 max-sm:px-3",children:[e.jsx("p",{className:"text-lg font-bold text-slate-700 max-sm:text-base",children:s==null?void 0:s.name}),e.jsxs("span",{className:"font-semibold max-sm:text-sm",children:[s==null?void 0:s.age,"  سنة"]}),e.jsx(X,{phone:(s==null?void 0:s.phone)??null,hasWhatsapp:(s==null?void 0:s.phone_has_whatsapp)??null}),(s==null?void 0:s.address)&&e.jsx("p",{className:"text-gray-400",children:s==null?void 0:s.address})]})})}const Pe=T(function(){const{id:a}=U();return e.jsxs("div",{className:"flex size-full max-h-full flex-1 flex-col gap-3 bg-gradient-to-b from-cyan-300/40 to-fuchsia-300/40 to-70% p-5 pb-2",children:[e.jsxs(H,{to:"/patients",className:"flex items-center self-end text-sm font-semibold text-slate-500 underline-offset-8 transition-all hover:text-primary hover:underline",children:["العودة للمرضى",e.jsx(W,{className:"size-3 stroke-slate-500"})]}),e.jsx("main",{className:"container mx-auto flex-1 overflow-auto",children:e.jsx(Z,{children:e.jsxs("div",{className:"flex size-full flex-1 flex-col divide-y-2 divide-slate-200 rounded-xl border border-primary/20 bg-white/50",children:[e.jsx(ce,{patientId:a??""}),e.jsx(le,{patientId:a??""})]})})})]})});export{Pe as default};
