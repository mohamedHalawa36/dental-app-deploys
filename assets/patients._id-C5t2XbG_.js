import{r as d,p as e,w as T,y as U,z as H}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{C as G}from"./ChevronLeft-DQqe5Vbc.js";import{k as h,w as y,t as q,x as k,u as j,c as _}from"./QueryClientProvider-B0e4pmks.js";import{D as z}from"./Calendar-CLtPXGTc.js";import{c as J,a as C,e as V,F as E,d as F}from"./index.esm-C0DY_CMF.js";import{P as R}from"./PageLoader-C78sVI-V.js";import{D as A}from"./DatePicker-BPDDC4nQ.js";import{B as g}from"./Button-CX5LaLF9.js";import{u as S}from"./input-D3y1GKQf.js";import{f as P}from"./time-CDh3KrcT.js";import{C as X,u as I,R as B}from"./RenderData-B43l8-Xj.js";import{P as Y,a as D,g as Z}from"./patient-4WdoAGYm.js";import{P as ee}from"./PageContext-CweN0xE8.js";import"./button-BX8rGgMC.js";import"./query-6el0zP7v.js";const K=J({doctor_id:C().required(h),patient_id:C().required(h),date:V().required(h),note:C().required(h)}),se=async a=>y.from("notes").select(`
      *,
      doctor:profiles(id,name)
    `).order("date",{ascending:!1}).eq("patient_id",a),te=async a=>{const t=await y.from("notes").insert([a]).select("*"),{error:r}=t;if(!r)q.success("تم إضافة الملاحظة");else throw new Error(r.message,{cause:t})},ae=async a=>{const t=await y.from("notes").update(a).eq("id",a.id).select("*"),{error:r}=t;if(!r)q.success("تم تعديل ملاحظتك");else throw new Error(r.message,{cause:t})},re=async a=>{const t=await y.from("notes").delete().eq("id",a).select("*"),{error:r}=t;if(!r)q.success("تم حذف الملاحظة");else throw new Error(r.message,{cause:t})};function ne({noteId:a}){const t=k(),[r,o]=d.useState(!1),{mutate:s,isPending:n}=S({mutationFn:re,onSuccess:()=>{t.invalidateQueries({queryKey:["notes"]})}});return e.jsx(X,{toggle:()=>o(l=>!l),isOpen:r,isActionsDisabled:n,title:"حذف ملاحظة",trigger:e.jsx("span",{className:"text-secondary transition-all hover:opacity-70",children:"حذف"}),confirmCallBack:()=>s(a),cancelCallBack:()=>o(!1),children:e.jsx("p",{children:"هل أنت متأكد من حذف الملاحظة"})})}function oe({id:a,date:t,note:r,doctor:o,patient_id:s}){const[n,l]=d.useState(!1),{userId:N}=j(),f=N===o.id,{mutate:i,isPending:m}=S({mutationFn:ae,onSuccess:()=>{l(!1)}}),w=o.name,v=P(new Date(t)),p=d.useRef(null);return d.useEffect(()=>{if(!n)return;const c=p.current;if(c){c.focus();const x=c.value.length;c.setSelectionRange(x,x)}},[n]),e.jsx(E,{initialValues:{id:a,doctor_id:o.id,patient_id:s,date:v,note:r},validationSchema:K,onSubmit:c=>i(c),children:({values:c,setFieldValue:x,resetForm:u,dirty:L,isValid:M})=>{const{date:Q,note:$,id:O}=c,W=new Date(Q);return e.jsxs(F,{className:"relative flex w-3/4 flex-col gap-3 max-lg:w-full",children:[m&&e.jsx(R,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-full flex-col gap-4 rounded-xl bg-white p-3 shadow-sm shadow-primary/40 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",w]})]}),e.jsx(A,{value:W,onChange:b=>x("date",b),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day",disabled:!n})]}),e.jsx("textarea",{rows:n?3.5:void 0,ref:p,placeholder:"اكتب ملاحظاتك هنا",className:_("rounded-xl border border-gray-200 bg-transparent p-2 text-left text-foreground transition-all placeholder:text-sm focus:outline-primary",{"resize-none":!n,"border border-gray-300":n}),name:"note",onChange:b=>x("note",b.target.value),value:$,disabled:!n}),f?!n&&e.jsxs("div",{className:"-mt-1 flex items-center justify-end gap-2 text-sm font-semibold",children:[e.jsx("button",{className:"text-primary transition-all hover:opacity-70",onClick:()=>l(!0),children:"تعديل"}),e.jsx(ne,{noteId:O})]}):null]}),n&&e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(g,{className:"w-20 p-2 text-sm max-sm:w-16",disabled:!M||!L,children:"حفظ"}),e.jsx(g,{variant:"secondary",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white max-sm:w-16",type:"button",onClick:()=>{u(),l(!1)},children:"إلغاء"})]})]})}})}function le({patientId:a}){const[t,r]=d.useState(!1),{userName:o,userId:s}=j(),n=k(),{mutate:l,isPending:N}=S({mutationFn:te,onSuccess:()=>{n.invalidateQueries({queryKey:["notes"]})}}),f=d.useRef(null);return d.useEffect(()=>{if(!t)return;const i=f.current;if(i){i.focus();const m=i.value.length;i.setSelectionRange(m,m)}},[t]),t?e.jsx(E,{initialValues:{doctor_id:s,patient_id:a,date:P(new Date),note:""},validationSchema:K,onSubmit:i=>l(i),children:({values:i,setFieldValue:m,isValid:w,dirty:v})=>{const{date:p}=i,c=new Date(p),x=new Date;return e.jsxs(F,{className:"relative flex w-full flex-col gap-3",children:[N&&e.jsx(R,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-3/4 flex-col gap-4 rounded-xl border border-gray-300 border-primary/40 bg-white p-3 max-lg:w-full",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",o]})]}),e.jsx(A,{value:c,onChange:u=>m("date",P(u??x)),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day"})]}),e.jsx("textarea",{ref:f,placeholder:"اكتب ملاحظاتك هنا",className:"rounded-xl border border-gray-300 bg-transparent p-2 text-left text-foreground transition-all placeholder:text-sm focus:outline-primary",name:"note",onChange:u=>m("note",u.target.value),rows:t?3.5:void 0})]}),e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(g,{className:"w-20 p-2 text-sm max-sm:w-16",type:"submit",disabled:!w||!v,children:"حفظ"}),e.jsx(g,{variant:"secondary",type:"button",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white max-sm:w-16",onClick:()=>r(!1),children:"إلغاء"})]})]})}}):e.jsxs("button",{onClick:()=>r(!0),className:"flex items-center gap-1.5 text-sm font-semibold text-primary hover:text-primary/80",children:[e.jsx(Y,{className:"size-5"}),"أضف ملاحظة"]})}function ie({patientId:a}){const{isDoctor:t}=j(),{isError:r,isFetching:o,data:s}=I({queryKey:["notes",a],queryFn:()=>se(a)}),n=s==null?void 0:s.data;return e.jsx(B,{isFetching:o,isError:r,isEmpty:!1,children:e.jsxs("div",{className:"flex flex-col items-start gap-4 overflow-auto px-5 py-4 max-sm:px-3 md:overflow-auto",children:[t&&e.jsx(le,{patientId:a}),n==null?void 0:n.map(l=>d.createElement(oe,{...l,key:l.id}))]})})}function ce({patientId:a}){const{data:t,isFetching:r,isError:o}=I({queryKey:["patient",a],queryFn:()=>Z(a)}),s=t==null?void 0:t.data,n=!s;return e.jsx(B,{isFetching:r,isError:o,isEmpty:n,children:e.jsxs("div",{className:"flex justify-between gap-1 px-5 py-4 max-sm:px-3",children:[e.jsxs("div",{className:"max-sm flex flex-col gap-1 rounded-xl",children:[e.jsx("p",{className:"text-lg font-bold text-slate-700 max-sm:text-base",children:s==null?void 0:s.name}),e.jsxs("span",{className:"font-semibold max-sm:text-sm",children:[s==null?void 0:s.age,"  سنة"]}),(s==null?void 0:s.address)&&e.jsx("p",{className:"text-gray-400",children:s==null?void 0:s.address})]}),e.jsxs("div",{className:"flex flex-col gap-1 p-1",children:[e.jsx(D,{phone:(s==null?void 0:s.phone1)??null,hasWhatsapp:(s==null?void 0:s.phone1_has_whatsapp)??null,className:"max-sm:text-xs"}),e.jsx(D,{phone:(s==null?void 0:s.phone2)??null,hasWhatsapp:(s==null?void 0:s.phone2_has_whatsapp)??null,className:"max-sm:text-xs"}),e.jsx(D,{phone:(s==null?void 0:s.phone3)??null,hasWhatsapp:(s==null?void 0:s.phone3_has_whatsapp)??null,className:"max-sm:text-xs"})]})]})})}const De=T(function(){const{id:t}=U(),{isDoctor:r}=j();return e.jsxs("div",{className:"flex size-full max-h-full flex-1 flex-col gap-3 bg-gradient-to-b from-cyan-300/40 to-fuchsia-300/40 to-70% p-3 pb-2 md:p-5",children:[e.jsxs(H,{to:"/patients",className:"flex items-center self-end text-sm font-semibold text-slate-500 underline-offset-8 transition-all hover:text-primary hover:underline",children:["العودة للمرضى",e.jsx(G,{className:"size-3 stroke-slate-500"})]}),e.jsx("main",{className:"container mx-auto flex-1 overflow-auto",children:e.jsx(ee,{children:e.jsxs("div",{className:_("flex size-full flex-1 flex-col divide-y-2 divide-slate-200 rounded-xl border border-primary/20 bg-white/50",{"mx-auto h-fit lg:w-1/2":!r}),children:[e.jsx(ce,{patientId:t??""}),r&&e.jsx(ie,{patientId:t??""})]})})})]})});export{De as default};
