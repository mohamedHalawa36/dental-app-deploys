import{p as s,r as d,w as L}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{i as z,j as V,u as $,R as Q,k as H}from"./RenderData-jVmtkm9k.js";import{t as b,a4 as A,a5 as W,m as J,w as N,x as w,u as P,a3 as X,c as _}from"./QueryClientProvider-BqTx5ubc.js";import{M as G,S as Y,D as Z,F as ee}from"./Delete-BgQps69E.js";import{T as se}from"./Table-DV0oalVO.js";import{u as C}from"./input-CSC9h8Uv.js";import{F as te}from"./index.esm-BiZX3RZs.js";import{L as ae,C as re}from"./label-BqGbnILP.js";import{I as j}from"./InputField-C3YZrV8p.js";import{a as ne,i as oe,r as ie}from"./schemas-Cyb-5gAU.js";import{f as F,m as ce,c as le,o as M,j as ue,X as de}from"./X-pPIl1Lk2.js";import{C as E}from"./ConfirmModal-DLK1UtK1.js";import{u as me}from"./usePageContext-DOW9hgN6.js";import"./query-DcHIp2lN.js";import"./PageLoader-DWnpqcPX.js";import"./Modal-l_hH5ou8.js";import"./ChevronLeft-YhJNbjfI.js";import"./button-D8mljs-1.js";import"./PageContext-DmRTTEtK.js";import"./Input-C7r7KRm1.js";const{success:{user:{delete:pe,add:he,activate:fe,deActivate:ge}}}=J,be=async({search:t,signal:r})=>{let e=N.from("profiles").select("*");return t.trim().length>0&&(e=e.ilike("name",`%${t}%`)),r&&(e=e.abortSignal(r)),await e},xe=async(t,r)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({user_id:t})}),a=await e.json();if(!e.ok)throw b.error(A),new Error((a==null?void 0:a.error)||"Failed to delete user");return b.success(pe),a},ye=async(t,r)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)}),a=await e.json();if(!e.ok)throw b.error(A),new W(a==null?void 0:a.error,e.status,a.code);return b.success(he),a},ve=async(t,r)=>{const{error:e}=await N.from("profiles").update({is_active:t}).eq("id",r).select("");e||b.success(t?fe:ge)};function ke({setIsOpen:t,usersEmails:r}){var c,o;const e=w(),a=(o=(c=P().authData)==null?void 0:c.session)==null?void 0:o.access_token,{mutate:i,isPending:l}=C({mutationFn:u=>ye(u,a),onSuccess:()=>{t(!1),e.invalidateQueries({queryKey:["users"]})}});return s.jsx(te,{initialValues:oe,validationSchema:ne(r),onSubmit:u=>i(u),validateOnChange:!0,children:s.jsxs(G,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[s.jsx(j,{label:"الاسم",name:"name",autoFocus:!X()}),s.jsx(Y,{label:"الوظيفة",name:"role",options:ie,placeholder:"اختر الوظيفة"}),s.jsx(j,{label:"البريد الإلكتروني",name:"email",type:"email",inputMode:"email",autoComplete:"email",autoCapitalize:"none",spellCheck:!1}),s.jsx(j,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),s.jsxs(ae,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[s.jsxs("span",{children:["مسؤول ","(Admin)"]}),s.jsx(re,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var v="Switch",[je,Je]=le(v),[we,Ce]=je(v),I=d.forwardRef((t,r)=>{const{__scopeSwitch:e,name:a,checked:i,defaultChecked:l,required:c,disabled:o,value:u="on",onCheckedChange:h,form:m,...n}=t,[p,f]=d.useState(null),g=F(r,y=>f(y)),k=d.useRef(!1),S=p?m||!!p.closest("form"):!0,[x,K]=ce({prop:i,defaultProp:l??!1,onChange:h,caller:v});return s.jsxs(we,{scope:e,checked:x,disabled:o,children:[s.jsx(M.button,{type:"button",role:"switch","aria-checked":x,"aria-required":c,"data-state":B(x),"data-disabled":o?"":void 0,disabled:o,value:u,...n,ref:g,onClick:ue(t.onClick,y=>{K(D=>!D),S&&(k.current=y.isPropagationStopped(),k.current||y.stopPropagation())})}),S&&s.jsx(q,{control:p,bubbles:!k.current,name:a,value:u,checked:x,required:c,disabled:o,form:m,style:{transform:"translateX(-100%)"}})]})});I.displayName=v;var O="SwitchThumb",T=d.forwardRef((t,r)=>{const{__scopeSwitch:e,...a}=t,i=Ce(O,e);return s.jsx(M.span,{"data-state":B(i.checked),"data-disabled":i.disabled?"":void 0,...a,ref:r})});T.displayName=O;var Se="SwitchBubbleInput",q=d.forwardRef(({__scopeSwitch:t,control:r,checked:e,bubbles:a=!0,...i},l)=>{const c=d.useRef(null),o=F(c,l),u=z(e),h=V(r);return d.useEffect(()=>{const m=c.current;if(!m)return;const n=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(n,"checked").set;if(u!==e&&f){const g=new Event("click",{bubbles:a});f.call(m,e),m.dispatchEvent(g)}},[u,e,a]),s.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:e,...i,tabIndex:-1,ref:o,style:{...i.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});q.displayName=Se;function B(t){return t?"checked":"unchecked"}var R=I,_e=T;const U=d.forwardRef(({className:t,...r},e)=>s.jsx(R,{className:_("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",t),...r,ref:e,children:s.jsx(_e,{className:_("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));U.displayName=R.displayName;function Ae({userId:t,active:r,disabled:e}){const a=w(),[i,l]=d.useState(!1),[c,o]=d.useState(r),{mutate:u,isPending:h}=C({mutationFn:()=>ve(c,t),onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),l(!1)}}),m=c?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return s.jsxs(s.Fragment,{children:[s.jsx(U,{disabled:e,checked:c,onCheckedChange:n=>{o(n),l(!0)}}),s.jsx(E,{toggle:()=>l(n=>!n),isOpen:i,isActionsDisabled:h,title:c?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>u(),cancelCallBack:()=>{l(!1),o(n=>!n)},children:s.jsxs("p",{children:["هل أنت متأكد من ",m," ؟"]})})]})}function Ne({userId:t}){var u;const r=w(),{authData:e}=P(),a=(u=e==null?void 0:e.session)==null?void 0:u.access_token,[i,l]=d.useState(!1),{mutate:c,isPending:o}=C({mutationFn:()=>xe(t,a),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),l(!1)}});return s.jsxs(E,{toggle:()=>l(h=>!h),isOpen:i,isActionsDisabled:o,title:"حذف مستخدم",trigger:s.jsx(Z,{className:"size-6 fill-red-600"}),confirmCallBack:()=>c(),cancelCallBack:()=>l(!1),confirmLabel:"حذف",children:[s.jsx("p",{children:"هل أنت متأكد؟"}),s.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد إيقاف الحساب مؤقتا يمكنك إلغاء تفعيل الحساب فقط"})]})}const Xe=L(function(){const{addNewOpen:r,setAddNewOpen:e,search:a}=me(),{data:i,isFetching:l,isError:c}=$({queryKey:["users",a],queryFn:async({signal:n})=>be({search:a,signal:n})}),o=(i==null?void 0:i.data)??[],u=(o==null?void 0:o.length)===0,h=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:n})=>n.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:n})=>n.getValue("is_admin")?s.jsx(H,{className:"stroke-green-600"}):s.jsx(de,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:n})=>{const p=n.getValue("is_admin"),f=n.getValue("is_active"),g=n.original.id;return s.jsx(Ae,{disabled:p,active:f,userId:g})}},{header:"تعديل",cell:({row:n})=>{const p=n.original.id,f=n.original.is_admin;return s.jsx("div",{className:"flex items-center gap-1",children:!f&&s.jsx(Ne,{userId:p})})}}],m=o.map(n=>n.email);return s.jsxs(s.Fragment,{children:[s.jsx(Q,{isEmpty:u,isFetching:l,isError:c,children:s.jsx(se,{data:o??[],columns:h})}),s.jsx(ee,{title:"إضافة مستخدم",isOpen:r,setIsOpen:e,children:s.jsx(ke,{usersEmails:m,setIsOpen:e})})]})});export{Xe as default};
