import{p as e,r as p,z as $}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{w,t as b,m as z,$ as G,c as C,k as v,W as J,a0 as k,x as P,a1 as T,u as W}from"./QueryClientProvider-B0e4pmks.js";import{S as Y,M as V,D as ee,F as M}from"./Delete-BOhSajKo.js";import{u as N,L as K,C as te}from"./RenderData-Bkj_49ts.js";import{u as _}from"./input-D3y1GKQf.js";import{c as H,f as se,a as f,u as E,F as Q,g as q,h as ne}from"./index.esm-C0DY_CMF.js";import{P as ae,X as ie,u as oe}from"./PageLoader-C78sVI-V.js";import{I as j}from"./InputField-Bsv0isQJ.js";import{b as re,P as le}from"./Pencil-B49a0cmu.js";import{f as ce}from"./time-CDh3KrcT.js";import{M as de}from"./query-CP5r1Lzd.js";import{W as me,P as ue,u as pe,f as he,g as xe,b as fe,c as ge,d as je,h as we,a as ye}from"./patient-BrpW5_n9.js";import{L as be,C as ve}from"./label-CcA-btli.js";const{add:Ce,update:Ne,delete:Pe}=z.success.appointment,{dayConflict:_e,timeConflict:Fe}=z.error.appointment,rt=async({search:t,date:n},a)=>{let s=w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).order("time",{ascending:!0});return n&&(s=s.eq("date",n)),t.trim().length>0&&(s=s.ilike("patients.name",`%${t}%`)),a?await s.abortSignal(a):await s},lt=async({search:t,date:n,doctorId:a},s)=>{let i=w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).eq("doctor_id",a).order("time",{ascending:!0});return n&&(i=i.eq("date",n)),t.trim().length>0&&(i=i.ilike("patients.name",`%${t}%`)),s?await i.abortSignal(s):await i},qe=async t=>await w.from("appointments").select(`
      *,
      patient:patients(*),
      doctor:profiles(id,name)
    `).eq("id",t).order("time",{ascending:!0}),Ae=async t=>{const n=await w.from("appointments").insert([t]).select("*"),{status:a,error:s}=n;if(!s)b.success(Ce);else throw a===409&&(b.dismiss(G),s.message.includes("unique_day_time")?b.error(Fe):b.error(_e)),new Error(s.message,{cause:n})},Se=async t=>{const{patient:n,...a}=t,s=await w.from("appointments").update(a).eq("id",t.id).select("*"),{error:i}=s;if(!i)b.success(Ne);else throw new Error(i.message,{cause:s})},ke=async t=>{const n=await w.from("appointments").delete().eq("id",t).select("*"),{error:a}=n;if(!a)b.success(Pe);else throw new Error(a.message,{cause:n})};function ct({children:t,className:n}){return e.jsx("div",{className:C("grid auto-rows-max grid-cols-[repeat(auto-fill,minmax(19rem,1fr))] gap-5 overflow-auto pe-2 max-sm:px-2",n),children:t})}var R=(t=>(t.APPOINTMENT="appointment",t.PATIENT="patient",t))(R||{});function U(){return e.jsx("div",{className:"p-5",children:e.jsx(ae,{})})}const Me=H({patient_id:f().required(v),doctor_id:f().required(v).when("availableDays",([t],n)=>n.test({name:"doctor-availability",message:"لاتوجد مواعيد متاحة للطبيب المختار",test:a=>t?!!a&&(t==null?void 0:t.length)>0:!0})),date:f().required(v).when("availableDays",([t],n)=>{var a,s;return n.test({name:"date-availability",message:`مواعيد الطبيب أيام ${(s=(a=t==null?void 0:t.sort())==null?void 0:a.map(i=>J(i.toString())))==null?void 0:s.join(" ، ")} فقط`,test:i=>{if(!(t!=null&&t.length))return!0;const o=new Date(i).getDay();return t==null?void 0:t.includes(o)}})}).test({name:"not-before-today",test:t=>{const n=new Date(t);return!k(n)},message:"لا يمكن حجز موعد بتاريخ قديم"}),time:f().nullable(),availableDays:se()}),Ee={patient_id:"",date:"",doctor_id:"",time:null,availableDays:[]},Oe=async()=>w.from("profiles").select("*").eq("role","doctor");function Be({patientName:t}){const{isFetching:n,data:a}=N({queryKey:["patients-select"],queryFn:()=>Oe(),select:u=>u.data}),s=(a==null?void 0:a.map(u=>({label:u.name,value:`${u.id}`})))??[],{values:i,setFieldValue:c,setFieldError:o}=E(),r=i.doctor_id,{data:l,refetch:d,isFetching:h}=N({queryKey:["availability",r],queryFn:()=>re(r),select:u=>u.data,enabled:!!r});p.useEffect(()=>{r&&d()},[d,r]);const m=p.useMemo(()=>l==null?void 0:l.map(u=>+u.day),[l]);p.useEffect(()=>{c("availableDays",m),o("date",void 0),o("time",void 0)},[m,o,c]);const x=!!r&&(m==null?void 0:m.length)===0,g=i.date;return e.jsxs(e.Fragment,{children:[e.jsx(j,{label:"اسم المريض",name:"patientId",value:t,defaultValue:t,disabled:!0,className:"[&>div>input]:!opacity-100"}),e.jsx(Y,{options:s,label:"الطبيب",name:"doctor_id",isDisabled:n,placeholder:n?". . . جاري التحميل":"اختر طبيب"}),e.jsx(j,{label:"التاريخ",name:"date",type:"date",value:g,placeholder:"اختر تاريخ",disabled:h||x,min:ce(new Date)}),e.jsx(j,{label:"الوقت",name:"time",type:"time",step:900,disabled:h||x,optional:!0})]})}function D({setIsOpen:t,patientData:n,appointmentId:a}){const{isFetching:s,data:i,isError:c}=N({queryKey:["appointment",a],queryFn:()=>qe(a??""),enabled:!!a,select:g=>{var u;return(u=g.data)==null?void 0:u[0]}}),o=a?i==null?void 0:i.patient:n,r=P(),{mutate:l,isPending:d}=_({mutationFn:a?Se:Ae,onSuccess:()=>{r.invalidateQueries({queryKey:["appointments"]}),t(!1)}});if(s)return e.jsx(U,{});if(c)return e.jsx(K,{});const h=o==null?void 0:o.name,m=o==null?void 0:o.id,x=a?i:{...Ee,patient_id:m};return e.jsx(Q,{initialValues:x,validationSchema:Me,onSubmit:g=>{const{availableDays:u,doctor:O,...F}=g;l(F)},enableReinitialize:!0,children:e.jsx(V,{submitBtnLabel:a?"تعديل":"حجز",isSubmitting:d,children:e.jsx(Be,{patientName:h})})})}function De({className:t}){return e.jsx("svg",{width:"27px",height:"27px",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:C("stroke-black",t),children:e.jsx("path",{d:"M12 7V12L9.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}function Le({onClick:t,className:n}){return e.jsx("span",{onClick:t,className:C("text-sm font-semibold text-primary transition hover:text-secondary hover:underline hover:underline-offset-4",n),children:"حجز موعد"})}function Ie({yesCallBack:t,noCallBack:n,patientName:a,isDisabled:s}){return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-7",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3",children:[e.jsx("span",{className:"text-xl font-bold",children:"هل تريد إلغاء موعد"}),e.jsx("span",{className:"font-semibold text-primary",children:a})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("button",{disabled:s,className:"h-fit w-20 rounded-xl border border-secondary px-5 py-2 font-medium text-secondary transition hover:bg-secondary hover:text-white",onClick:t,children:"نعم"}),e.jsx("button",{disabled:s,className:"h-fit w-20 rounded-xl border border-foreground px-5 py-2 font-medium text-foreground transition hover:bg-foreground hover:text-white",onClick:n,children:"لا"})]})]})}function $e({appointmentId:t,patientName:n}){const[a,s]=p.useState(!1),i=P(),{mutate:c,isPending:o}=_({mutationFn:ke,onSuccess:()=>{s(!1),i.invalidateQueries({queryKey:["appointments"]})}});return e.jsx(de,{title:"إلغاء موعد",className:"h-fit w-11/12 overflow-hidden rounded-lg md:w-2/5 lg:w-[25.5rem]",isOpen:a,toggle:r=>s(r??!1),trigger:e.jsx("div",{className:"h-fit rounded-xl border border-secondary px-4 py-1.5 text-sm font-medium text-secondary transition hover:bg-secondary hover:text-white",children:"إلغاء"}),children:e.jsx(Ie,{yesCallBack:()=>c(t),noCallBack:()=>s(!1),patientName:n,isDisabled:o})})}const A=/^01[0-25]\d{8}$/,ze=H({name:f().required(v),age:ne().typeError("أرقام فقط").required(v).min(3,"العمر غير صحيح").max(120,"العمر غير صحيح"),address:f(),phone1:f().typeError("أرقام فقط").required(v).matches(A,"رقم غير صحيح"),phone1_has_whatsapp:q(),phone2:f().nullable().typeError("أرقام فقط").matches(A,"رقم غير صحيح"),phone2_has_whatsapp:q().nullable(),phone3:f().nullable().typeError("أرقام فقط").matches(A,"رقم غير صحيح"),phone3_has_whatsapp:q().nullable()}),Te={name:"",age:"",address:"",phone1:"",phone1_has_whatsapp:!1,phone2:null,phone2_has_whatsapp:null,phone3:null,phone3_has_whatsapp:null};function Z({label:t,name:n,className:a,optional:s}){const{getFieldProps:i,getFieldMeta:c}=E(),{value:o}=i(n),{error:r}=c(n),h=!!o?!!(r??!1):!0;return e.jsxs("div",{className:C("flex gap-2",a),children:[e.jsx(j,{inputMode:"numeric",pattern:"[0-9]*",label:t,name:n,className:"w-full flex-1",optional:s,onKeyDown:T}),e.jsxs(be,{htmlFor:`${n}_has_whatsapp`,className:"mt-2 flex items-center gap-1.5",children:[e.jsx(me,{className:"max-sm:size-5"}),e.jsx(ve,{className:"max-sm:size-4",name:`${n}_has_whatsapp`,disabled:h})]})]})}function We(){const{setFieldValue:t,getFieldProps:n}=E(),a=n("phone2").value,s=n("phone3").value,i=n("phone2_has_whatsapp").value,c=n("phone3_has_whatsapp").value,[o,r]=p.useState(!!a),[l,d]=p.useState(!!s),h=!(o&&l);return p.useEffect(()=>{a?i||t("phone2_has_whatsapp",!1):(t("phone2",null),t("phone2_has_whatsapp",null)),s?c||t("phone3_has_whatsapp",!1):(t("phone3",null),t("phone3_has_whatsapp",null))},[a,i,s,c,t]),e.jsxs(e.Fragment,{children:[o&&e.jsx(L,{className:"w-full",label:"هاتف إضافي 1",name:"phone2",onChange:()=>{},optional:!0,onCancel:()=>{if(s){t("phone2",s),t("phone2_has_whatsapp",c),t("phone3",null),t("phone3_has_whatsapp",null),d(!1);return}if(t("phone2",""),t("phone2_has_whatsapp",null),l)return d(!1);r(!1)}}),l&&e.jsx(L,{className:"w-full",label:"هاتف إضافي 2",name:"phone3",onChange:()=>{},optional:!0,onCancel:()=>{d(!1),t("phone3",null),t("phone3_has_whatsapp",null)}}),h&&e.jsx(Ve,{onClick:()=>{o?d(!0):r(!0)}})]})}function Ve({onClick:t}){return e.jsxs("button",{onClick:t,className:"flex w-fit items-center gap-1.5 text-sm font-semibold text-primary hover:text-primary/80 max-md:mb-4 max-md:py-1.5 md:mt-2",type:"button",tabIndex:-1,children:[e.jsx(ue,{className:"size-5"}),"هاتف إضافي"]})}function L({onCancel:t,...n}){return e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsx(Z,{...n}),e.jsx("button",{type:"button",tabIndex:-1,onClick:t,children:e.jsx(ie,{className:"mt-1.5 size-5 fill-secondary stroke-secondary"})})]})}function Ke({setIsOpen:t,patientId:n}){const{isFetching:a,isError:s,data:i}=N({queryKey:["patient",n],queryFn:()=>xe(n??""),enabled:!!n}),c=P(),{mutate:o,isPending:r}=_({mutationFn:n?pe:he,onSuccess:()=>{t(!1),c.invalidateQueries({queryKey:["patients"]})}});if(a)return e.jsx(U,{});if(s)return e.jsx(K,{});const l=i==null?void 0:i.data;return e.jsx(Q,{initialValues:n?l:Te,validationSchema:ze,onSubmit:d=>o(d),validateOnChange:!0,children:e.jsx(e.Fragment,{children:e.jsxs(V,{isSubmitting:r,submitBtnLabel:n?"تعديل":"إضافة",children:[e.jsx(j,{label:"الاسم",name:"name",autoFocus:!0}),e.jsx(j,{onKeyDown:T,label:"العمر",name:"age",inputMode:"numeric"}),e.jsx(Z,{label:"رقم الهاتف",name:"phone1",onChange:()=>{}}),e.jsx(We,{}),e.jsx(j,{label:"العنوان",name:"address",optional:!0})]})})})}const He=({className:t})=>e.jsx("svg",{width:"4",height:"16",viewBox:"0 0 4 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:C(t),children:e.jsx("path",{d:"M2 16C1.45 16 0.979167 15.8042 0.5875 15.4125C0.195833 15.0208 0 14.55 0 14C0 13.45 0.195833 12.9792 0.5875 12.5875C0.979167 12.1958 1.45 12 2 12C2.55 12 3.02083 12.1958 3.4125 12.5875C3.80417 12.9792 4 13.45 4 14C4 14.55 3.80417 15.0208 3.4125 15.4125C3.02083 15.8042 2.55 16 2 16ZM2 10C1.45 10 0.979167 9.80417 0.5875 9.4125C0.195833 9.02083 0 8.55 0 8C0 7.45 0.195833 6.97917 0.5875 6.5875C0.979167 6.19583 1.45 6 2 6C2.55 6 3.02083 6.19583 3.4125 6.5875C3.80417 6.97917 4 7.45 4 8C4 8.55 3.80417 9.02083 3.4125 9.4125C3.02083 9.80417 2.55 10 2 10ZM2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4Z",fill:"#343434"})});function Qe({className:t}){return e.jsx("svg",{width:"27px",height:"27px",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg",className:C("",t),children:e.jsxs("g",{fill:"gray",children:[e.jsx("path",{d:"M8 16a8 8 0 0 1-8-8 8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8zm0-1a7 7 0 0 0 7-7 7 7 0 0 0-7-7 7 7 0 0 0-7 7 7 7 0 0 0 7 7z"}),e.jsx("path",{d:"M8 3.75c-.386 0-.69.124-.914.373A1.269 1.269 0 0 0 6.75 5c0 .336.112.628.336.877.224.249.528.373.914.373s.69-.124.914-.373c.224-.249.336-.541.336-.877 0-.336-.112-.628-.336-.877C8.69 3.874 8.386 3.75 8 3.75zM7 7v5h2V7z",fontFamily:"Ubuntu",fontWeight:"400",letterSpacing:"0",wordSpacing:"0"})]})})}function Re({patient:t}){const[n,a]=p.useState(!1),[s,i]=p.useState(!1),[c,o]=p.useState(!1),{userId:r,isDoctor:l,isNurse:d,isAdmin:h}=W(),m=p.useRef(null),x=t==null?void 0:t.id,g=t==null?void 0:t.name,u=P(),{mutate:O,isPending:F}=_({mutationFn:we,onSuccess:()=>{o(!1),u.invalidateQueries({queryKey:["patients"]})}});p.useEffect(()=>{const y=()=>{var B;(B=m.current)==null||B.focus({preventScroll:!0}),a(!1)};return document.addEventListener("wheel",y),document.addEventListener("touchmove",y),()=>{document.removeEventListener("wheel",y),document.removeEventListener("touchmove",y)}},[]),oe(()=>{n&&(a==null||a(!1))},[n]);const X=h||d||l&&r===(t==null?void 0:t.user_id);return e.jsxs(fe,{open:n,onOpenChange:a,children:[e.jsxs("div",{className:"relative -m-1.5",children:[e.jsx(ge,{ref:m,className:"flex size-8 items-center justify-center rounded-full transition-all hover:bg-gray-50",children:e.jsx(He,{})}),e.jsxs(je,{align:"end",className:"-mt-1 flex h-fit w-40 !animate-none flex-col overflow-hidden rounded-lg bg-white p-0 drop-shadow-md !duration-0",children:[e.jsx($,{to:`/patients/${x}`,children:e.jsx(S,{label:"تفاصيل",icon:e.jsx(Qe,{className:"size-[22.5px]"})})}),X&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>i(!0),children:e.jsx(S,{label:"تعديل",icon:e.jsx(le,{className:"-me-1 -ms-1 h-7 w-8"})})}),e.jsx(te,{isOpen:c,toggle:()=>o(y=>!y),title:"حذف مريض",trigger:e.jsx(S,{label:"حذف",icon:e.jsx(ee,{className:"size-[22.5px] fill-red-600"})}),confirmCallBack:()=>O(x??""),cancelCallBack:()=>o(!1),isActionsDisabled:F,children:e.jsxs("p",{className:"text-lg font-semibold",children:["هل تريد حذف ملف  ",e.jsx("span",{className:"text-primary",children:g}),"  ؟"]})})]})]})]}),e.jsx(M,{title:"تعديل مريض",isOpen:s,setIsOpen:i,children:e.jsx(Ke,{setIsOpen:i,patientId:x})})]})}const S=({label:t,icon:n})=>e.jsxs("span",{className:"flex items-center gap-2 px-2.5 py-2 text-sm transition-all hover:bg-gray-50",children:[n,t]});function I({PatientId:t}){return e.jsx($,{to:`/patients/${t}`,className:"text-sm font-semibold text-primary transition-all hover:underline hover:underline-offset-4",children:"تفاصيل"})}function dt(t){const[n,a]=p.useState(!1),{patient:s,variant:i}=t,c=(s==null?void 0:s.name)??"",o=(s==null?void 0:s.phone1)??"",r=(s==null?void 0:s.phone1_has_whatsapp)??!1,l=i===R.PATIENT,{isAdmin:d,isNurse:h}=W(),m=h||d,x=l&&m;return e.jsxs("div",{className:"group flex h-fit w-full flex-col gap-5 rounded-xl bg-white px-3 py-4 transition duration-200 hover:shadow-md max-sm:gap-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 max-lg:justify-center max-lg:gap-2",children:[e.jsx("div",{className:"flex flex-1 flex-col gap-1 text-foreground group-hover:text-primary",children:e.jsx("h4",{className:"h-10 text-sm font-bold lg:h-12 lg:text-base",children:c})}),!l&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[m?k(new Date(t.date))?null:e.jsx(M,{title:"تعديل موعد",isOpen:n,setIsOpen:a,trigger:e.jsx("span",{className:"inline-flex w-full self-start text-xs font-semibold text-primary transition-all hover:text-secondary hover:underline max-sm:text-xs",children:"تغيير"}),children:e.jsx(D,{setIsOpen:a,appointmentId:t.appointmentId})}):null,e.jsxs("div",{className:"-mb-1 flex items-center gap-1",children:[e.jsx("span",{style:{direction:"ltr"},className:"text-sm font-medium text-foreground",children:!l&&t.time?t.time:"--:--"}),e.jsx(De,{className:"-me-0.5 size-5"})]})]}),x&&e.jsx(Re,{patient:s})]}),e.jsxs("div",{className:"flex items-end justify-between max-lg:gap-2",children:[e.jsx(ye,{phone:o,hasWhatsapp:r}),l?null:m?k(new Date(t.date))?null:e.jsx($e,{appointmentId:t.appointmentId,patientName:(s==null?void 0:s.name)??""}):e.jsx(I,{PatientId:(s==null?void 0:s.id)??""}),l?m?e.jsx(M,{title:"حجز موعد",isOpen:n,setIsOpen:a,trigger:e.jsx(Le,{onClick:()=>{}}),children:e.jsx(D,{setIsOpen:a,patientData:s??void 0})}):e.jsx(I,{PatientId:(s==null?void 0:s.id)??""}):null]})]})}export{ct as C,dt as P,R as a,rt as b,Ke as c,lt as g};
