import{r as d,p as e,w as T,y as U,z as H}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{C as W}from"./ChevronLeft-DQqe5Vbc.js";import{k as h,w as y,t as P,x as S,u as D,c as k}from"./QueryClientProvider-B0e4pmks.js";import{D as z}from"./Calendar-CLtPXGTc.js";import{c as G,a as w,e as J,F as E,d as F}from"./index.esm-C0DY_CMF.js";import{P as R}from"./PageLoader-DZP7-pmZ.js";import{D as _}from"./DatePicker-1vr-lRn_.js";import{B as g}from"./Button-CX5LaLF9.js";import{u as q}from"./input-D3y1GKQf.js";import{f as C}from"./time-CDh3KrcT.js";import{C as V,u as A,R as I}from"./RenderData-BJF09N81.js";import{P as X,g as Y}from"./patient-jbYBUO7p.js";import{P as Z}from"./PageContext-CweN0xE8.js";import"./button-D5cQVpE8.js";import"./query-eic4WXM_.js";const B=G({doctor_id:w().required(h),patient_id:w().required(h),date:J().required(h),note:w().required(h)}),ee=async a=>y.from("notes").select(`
      *,
      doctor:profiles(id,name)
    `).order("date",{ascending:!1}).eq("patient_id",a),se=async a=>{const t=await y.from("notes").insert([a]).select("*"),{error:r}=t;if(!r)P.success("تم إضافة الملاحظة");else throw new Error(r.message,{cause:t})},te=async a=>{const t=await y.from("notes").update(a).eq("id",a.id).select("*"),{error:r}=t;if(!r)P.success("تم تعديل ملاحظتك");else throw new Error(r.message,{cause:t})},ae=async a=>{const t=await y.from("notes").delete().eq("id",a).select("*"),{error:r}=t;if(!r)P.success("تم حذف الملاحظة");else throw new Error(r.message,{cause:t})};function re({noteId:a}){const t=S(),[r,o]=d.useState(!1),{mutate:s,isPending:n}=q({mutationFn:ae,onSuccess:()=>{t.invalidateQueries({queryKey:["notes"]})}});return e.jsx(V,{toggle:()=>o(i=>!i),isOpen:r,isActionsDisabled:n,title:"حذف ملاحظة",trigger:e.jsx("span",{className:"text-secondary transition-all hover:opacity-70",children:"حذف"}),confirmCallBack:()=>s(a),cancelCallBack:()=>o(!1),children:e.jsx("p",{children:"هل أنت متأكد من حذف الملاحظة"})})}function ne({id:a,date:t,note:r,doctor:o,patient_id:s}){const[n,i]=d.useState(!1),{userId:j}=D(),f=j===o.id,{mutate:l,isPending:m}=q({mutationFn:te,onSuccess:()=>{i(!1)}}),v=o.name,N=C(new Date(t)),p=d.useRef(null);return d.useEffect(()=>{if(!n)return;const c=p.current;if(c){c.focus();const x=c.value.length;c.setSelectionRange(x,x)}},[n]),e.jsx(E,{initialValues:{id:a,doctor_id:o.id,patient_id:s,date:N,note:r},validationSchema:B,onSubmit:c=>l(c),children:({values:c,setFieldValue:x,resetForm:u,dirty:K,isValid:L})=>{const{date:M,note:Q,id:$}=c,O=new Date(M);return e.jsxs(F,{className:"relative flex w-3/4 flex-col gap-3 max-lg:w-full",children:[m&&e.jsx(R,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-full flex-col gap-4 rounded-xl bg-white p-3 shadow-sm shadow-primary/40 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",v]})]}),e.jsx(_,{value:O,onChange:b=>x("date",b),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day",disabled:!n})]}),e.jsx("textarea",{rows:n?3.5:void 0,ref:p,placeholder:"اكتب ملاحظاتك هنا",className:k("rounded-xl border border-gray-200 bg-transparent p-2 text-left text-foreground transition-all placeholder:text-sm focus:outline-primary",{"resize-none":!n,"border border-gray-300":n}),name:"note",onChange:b=>x("note",b.target.value),value:Q,disabled:!n}),f?!n&&e.jsxs("div",{className:"-mt-1 flex items-center justify-end gap-2 text-sm font-semibold",children:[e.jsx("button",{className:"text-primary transition-all hover:opacity-70",onClick:()=>i(!0),children:"تعديل"}),e.jsx(re,{noteId:$})]}):null]}),n&&e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(g,{className:"w-20 p-2 text-sm max-sm:w-16",disabled:!L||!K,children:"حفظ"}),e.jsx(g,{variant:"secondary",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white max-sm:w-16",type:"button",onClick:()=>{u(),i(!1)},children:"إلغاء"})]})]})}})}function oe({className:a}){return e.jsx("div",{className:k("flex size-7 items-center justify-center rounded-full border-2 border-primary text-xl",a),children:"+"})}function ie({patientId:a}){const[t,r]=d.useState(!1),{userName:o,userId:s}=D(),n=S(),{mutate:i,isPending:j}=q({mutationFn:se,onSuccess:()=>{n.invalidateQueries({queryKey:["notes"]})}}),f=d.useRef(null);return d.useEffect(()=>{if(!t)return;const l=f.current;if(l){l.focus();const m=l.value.length;l.setSelectionRange(m,m)}},[t]),t?e.jsx(E,{initialValues:{doctor_id:s,patient_id:a,date:C(new Date),note:""},validationSchema:B,onSubmit:l=>i(l),children:({values:l,setFieldValue:m,isValid:v,dirty:N})=>{const{date:p}=l,c=new Date(p),x=new Date;return e.jsxs(F,{className:"relative flex w-full flex-col gap-3",children:[j&&e.jsx(R,{className:"absolute inset-0 m-0 size-full bg-slate-100/50"}),e.jsxs("div",{className:"flex w-3/4 flex-col gap-4 rounded-xl border border-gray-300 border-primary/40 bg-white p-3 max-lg:w-full",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"size-5"}),e.jsxs("span",{className:"text-sm",children:["د/ ",o]})]}),e.jsx(_,{value:c,onChange:u=>m("date",C(u??x)),className:"w-fit text-sm text-primary [&>svg]:!size-5 [&>svg]:stroke-primary",granularity:"day"})]}),e.jsx("textarea",{ref:f,placeholder:"اكتب ملاحظاتك هنا",className:"rounded-xl border border-gray-300 bg-transparent p-2 text-left text-foreground transition-all placeholder:text-sm focus:outline-primary",name:"note",onChange:u=>m("note",u.target.value),rows:t?3.5:void 0})]}),e.jsxs("div",{className:"ms-1 flex w-fit items-center gap-3",children:[e.jsx(g,{className:"w-20 p-2 text-sm max-sm:w-16",type:"submit",disabled:!v||!N,children:"حفظ"}),e.jsx(g,{variant:"secondary",type:"button",className:"w-20 border-secondary p-2 text-sm text-secondary hover:bg-secondary hover:text-white max-sm:w-16",onClick:()=>r(!1),children:"إلغاء"})]})]})}}):e.jsxs("button",{onClick:()=>r(!0),className:"flex items-center gap-1.5 text-sm font-semibold text-primary hover:text-primary/80",children:[e.jsx(oe,{className:"size-5"}),"أضف ملاحظة"]})}function le({patientId:a}){const{isDoctor:t}=D(),{isError:r,isFetching:o,data:s}=A({queryKey:["notes",a],queryFn:()=>ee(a)}),n=s==null?void 0:s.data;return e.jsx(I,{isFetching:o,isError:r,isEmpty:!1,children:e.jsxs("div",{className:"flex flex-col items-start gap-4 overflow-auto px-5 py-4 max-sm:px-3 md:overflow-auto",children:[t&&e.jsx(ie,{patientId:a}),n==null?void 0:n.map(i=>d.createElement(ne,{...i,key:i.id}))]})})}function ce({patientId:a}){const{data:t,isFetching:r,isError:o}=A({queryKey:["patient",a],queryFn:()=>Y(a)}),s=t==null?void 0:t.data,n=!s;return e.jsx(I,{isFetching:r,isError:o,isEmpty:n,children:e.jsxs("div",{className:"max-sm flex flex-col gap-1 rounded-xl px-5 py-3 max-sm:px-3",children:[e.jsx("p",{className:"text-lg font-bold text-slate-700 max-sm:text-base",children:s==null?void 0:s.name}),e.jsxs("span",{className:"font-semibold max-sm:text-sm",children:[s==null?void 0:s.age,"  سنة"]}),e.jsx(X,{phone:(s==null?void 0:s.phone)??null,hasWhatsapp:(s==null?void 0:s.phone_has_whatsapp)??null}),(s==null?void 0:s.address)&&e.jsx("p",{className:"text-gray-400",children:s==null?void 0:s.address})]})})}const Pe=T(function(){const{id:t}=U();return e.jsxs("div",{className:"flex size-full max-h-full flex-1 flex-col gap-3 bg-gradient-to-b from-cyan-300/40 to-fuchsia-300/40 to-70% p-5 pb-2",children:[e.jsxs(H,{to:"/patients",className:"flex items-center self-end text-sm font-semibold text-slate-500 underline-offset-8 transition-all hover:text-primary hover:underline",children:["العودة للمرضى",e.jsx(W,{className:"size-3 stroke-slate-500"})]}),e.jsx("main",{className:"container mx-auto flex-1 overflow-auto",children:e.jsx(Z,{children:e.jsxs("div",{className:"flex size-full flex-1 flex-col divide-y-2 divide-slate-200 rounded-xl border border-primary/20 bg-white/50",children:[e.jsx(ce,{patientId:t??""}),e.jsx(le,{patientId:t??""})]})})})]})});export{Pe as default};
