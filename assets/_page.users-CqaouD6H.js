import{p as e,r as y,w as F}from"./chunk-PVWAREVJ-chYXeG9N.js";import{M as k,e as w,C as q,D as O,u as S,R as _,F as v,k as A}from"./Delete-uu9hnkAx.js";import{t as p,Y as j,m as N,V as M,k as u,P as b,u as x}from"./QueryClientProvider-Xy3iKmL1.js";import{T as P}from"./Table-BlVHF3N7.js";import{u as C}from"./Input-DuMdQrAz.js";import{c as T,a as d,f as U,F as I,I as f}from"./index.esm-CQa9_x3t.js";import{L as K,C as $}from"./label-DgplrDYf.js";import{d as E,X as B}from"./X-COVWdvlK.js";import"./query-CXdU6cDq.js";import"./useAttachBackBtn-D2A7XsYt.js";import"./button-D8rxGqGp.js";const{success:{user:{delete:D,add:V}}}=N,z=async()=>await M.from("profiles").select("*"),L=async(r,t)=>{const a=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({user_id:r})}),s=await a.json();if(!a.ok)throw p.error(j),new Error((s==null?void 0:s.error)||"Failed to delete user");return p.success(D),s},Q=async(r,t)=>{const a=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r)}),s=await a.json();if(!a.ok)throw p.error(j),new Error((s==null?void 0:s.error)||"Failed to create user");return p.success(V),s},R=T({email:d().email("البريد الإلكتروني غير صحيح").required(u),password:d().min(6,"يجب أن لا تقل كلمة السر عن 6 حروف").required(u),name:d().required(u),is_admin:U().required(u),role:d().required(u).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),J={email:"",password:"",name:"",is_admin:!1,role:""},W=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function X({setIsOpen:r}){var o,n;const t=b(),a=(n=(o=x().authData)==null?void 0:o.session)==null?void 0:n.access_token,{mutate:s,isPending:l}=C({mutationFn:c=>Q(c,a),onSuccess:()=>{r(!1),t.invalidateQueries({queryKey:["users"]})}});return e.jsx(I,{initialValues:J,validationSchema:R,onSubmit:c=>s(c),validateOnChange:!0,children:e.jsxs(k,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[e.jsx(f,{label:"الاسم",name:"name"}),e.jsx(w,{label:"الوظيفة",name:"role",options:W,placeholder:"اختر الوظيفة"}),e.jsx(f,{label:"البريد الإلكتروني",name:"email"}),e.jsx(f,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),e.jsxs(K,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[e.jsxs("span",{children:["مسؤول ","(Admin)"]}),e.jsx($,{className:"max-sm:size-4",name:"is_admin"})]})]})})}function Y({userId:r}){var m;const t=b(),{authData:a}=x(),s=(m=a==null?void 0:a.session)==null?void 0:m.access_token,[l,o]=y.useState(!1),{mutate:n,isPending:c}=C({mutationFn:()=>L(r,s),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),o(!1)}});return e.jsx(q,{toggle:()=>o(i=>!i),isOpen:l,isActionsDisabled:c,title:"حذف مستخدم",trigger:e.jsx(O,{className:"size-6 fill-red-600"}),confirmCallBack:()=>n(),cancelCallBack:()=>o(!1),children:e.jsx("p",{children:"هل أنت متأكد من حذف هذا المستخدم"})})}const ce=F(function(){const{addNewOpen:t,setAddNewOpen:a}=y.useContext(E);x();const{data:s,isFetching:l,isError:o}=S({queryKey:["users"],queryFn:z}),n=(s==null?void 0:s.data)??[],c=(n==null?void 0:n.length)===0,m=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:i})=>i.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"Admin",cell:({row:i})=>i.getValue("is_admin")?e.jsx(A,{className:"stroke-green-600"}):e.jsx(B,{className:"fill-red-600"})},{header:"تعديل",cell:({row:i})=>{const h=i.original.id,g=i.original.is_admin;return e.jsx("div",{className:"flex items-center gap-1",children:!g&&e.jsx(Y,{userId:h})})}}];return e.jsxs(e.Fragment,{children:[e.jsx(_,{isEmpty:c,isFetching:l,isError:o,children:e.jsx(P,{data:n??[],columns:m})}),e.jsx(v,{title:"إضافة مستخدم",isOpen:t,setIsOpen:a,children:e.jsx(X,{setIsOpen:a})})]})});export{ce as default};
