import{p as s,r as u,w as V}from"./chunk-PVWAREVJ-BUjujdbQ.js";import{M as Q,e as H,k as W,l as J,C as P,D as X,u as G,R as Y,F as Z,m as ee}from"./Delete-QQSdM6rl.js";import{t as x,a2 as q,a3 as se,m as F,_ as E,k as b,U as C,u as M,c as N}from"./QueryClientProvider-BWsEC_BQ.js";import{T as te}from"./Table-B370ZS71.js";import{u as _}from"./Input-DxPsCDaV.js";import{c as ae,a as k,f as re,F as ne,I as S}from"./index.esm-DqRZ8-eI.js";import{L as ie,C as oe}from"./label-B5nIArR3.js";import{g as O,n as ce,d as le,p as I,k as de,X as ue}from"./PageLoader-TM_fbL5H.js";import{u as me}from"./usePageContext-Dz7Ef935.js";import"./query-CGH72VCv.js";import"./button-6HuqxDin.js";const{success:{user:{delete:pe,add:he,activate:fe,deActivate:ge}}}=F,be=async({search:t,signal:a})=>{let e=E.from("profiles").select("*");return t.trim().length>0&&(e=e.ilike("name",`%${t}%`)),a&&(e=e.abortSignal(a)),await e},xe=async(t,a)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({user_id:t})}),r=await e.json();if(!e.ok)throw x.error(q),new Error((r==null?void 0:r.error)||"Failed to delete user");return x.success(pe),r},ve=async(t,a)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(t)}),r=await e.json();if(!e.ok)throw x.error(q),new se(r==null?void 0:r.error,e.status,r.code);return x.success(he),r},ye=async(t,a)=>{const{error:e}=await E.from("profiles").update({is_active:t}).eq("id",a).select("");e||x.success(t?fe:ge)},ke=t=>ae({email:k().email("البريد الإلكتروني غير صحيح").required(b).test({test:a=>!t.includes(a),message:F.error.user.emailExists}),password:k().min(6,"يجب أن لا تقل كلمة السر عن 6 حروف").required(b),name:k().required(b),is_admin:re().required(b),role:k().required(b).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),we={email:"",password:"",name:"",is_admin:!1,role:""},je=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function Se({setIsOpen:t,usersEmails:a}){var c,i;const e=C(),r=(i=(c=M().authData)==null?void 0:c.session)==null?void 0:i.access_token,{mutate:o,isPending:l}=_({mutationFn:d=>ve(d,r),onSuccess:()=>{t(!1),e.invalidateQueries({queryKey:["users"]})}});return s.jsx(ne,{initialValues:we,validationSchema:ke(a),onSubmit:d=>o(d),validateOnChange:!0,children:s.jsxs(Q,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[s.jsx(S,{label:"الاسم",name:"name",autoFocus:!0}),s.jsx(H,{label:"الوظيفة",name:"role",options:je,placeholder:"اختر الوظيفة"}),s.jsx(S,{label:"البريد الإلكتروني",name:"email"}),s.jsx(S,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),s.jsxs(ie,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[s.jsxs("span",{children:["مسؤول ","(Admin)"]}),s.jsx(oe,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var w="Switch",[Ce,De]=le(w),[_e,Ae]=Ce(w),T=u.forwardRef((t,a)=>{const{__scopeSwitch:e,name:r,checked:o,defaultChecked:l,required:c,disabled:i,value:d="on",onCheckedChange:h,form:m,...n}=t,[p,f]=u.useState(null),g=O(a,y=>f(y)),j=u.useRef(!1),A=p?m||!!p.closest("form"):!0,[v,D]=ce({prop:o,defaultProp:l??!1,onChange:h,caller:w});return s.jsxs(_e,{scope:e,checked:v,disabled:i,children:[s.jsx(I.button,{type:"button",role:"switch","aria-checked":v,"aria-required":c,"data-state":K(v),"data-disabled":i?"":void 0,disabled:i,value:d,...n,ref:g,onClick:de(t.onClick,y=>{D(z=>!z),A&&(j.current=y.isPropagationStopped(),j.current||y.stopPropagation())})}),A&&s.jsx(U,{control:p,bubbles:!j.current,name:r,value:d,checked:v,required:c,disabled:i,form:m,style:{transform:"translateX(-100%)"}})]})});T.displayName=w;var B="SwitchThumb",R=u.forwardRef((t,a)=>{const{__scopeSwitch:e,...r}=t,o=Ae(B,e);return s.jsx(I.span,{"data-state":K(o.checked),"data-disabled":o.disabled?"":void 0,...r,ref:a})});R.displayName=B;var Ne="SwitchBubbleInput",U=u.forwardRef(({__scopeSwitch:t,control:a,checked:e,bubbles:r=!0,...o},l)=>{const c=u.useRef(null),i=O(c,l),d=W(e),h=J(a);return u.useEffect(()=>{const m=c.current;if(!m)return;const n=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(n,"checked").set;if(d!==e&&f){const g=new Event("click",{bubbles:r});f.call(m,e),m.dispatchEvent(g)}},[d,e,r]),s.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:e,...o,tabIndex:-1,ref:i,style:{...o.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});U.displayName=Ne;function K(t){return t?"checked":"unchecked"}var $=T,Pe=R;const L=u.forwardRef(({className:t,...a},e)=>s.jsx($,{className:N("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",t),...a,ref:e,children:s.jsx(Pe,{className:N("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));L.displayName=$.displayName;function qe({userId:t,active:a,disabled:e}){const r=C(),[o,l]=u.useState(!1),[c,i]=u.useState(a),{mutate:d,isPending:h}=_({mutationFn:()=>ye(c,t),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),l(!1)}}),m=c?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return s.jsxs(s.Fragment,{children:[s.jsx(L,{disabled:e,checked:c,onCheckedChange:n=>{i(n),l(!0)}}),s.jsx(P,{toggle:()=>l(n=>!n),isOpen:o,isActionsDisabled:h,title:c?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>d(),cancelCallBack:()=>{l(!1),i(n=>!n)},children:s.jsxs("p",{children:["هل أنت متأكد من ",m," ؟"]})})]})}function Fe({userId:t}){var d;const a=C(),{authData:e}=M(),r=(d=e==null?void 0:e.session)==null?void 0:d.access_token,[o,l]=u.useState(!1),{mutate:c,isPending:i}=_({mutationFn:()=>xe(t,r),onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),l(!1)}});return s.jsxs(P,{toggle:()=>l(h=>!h),isOpen:o,isActionsDisabled:i,title:"حذف مستخدم",trigger:s.jsx(X,{className:"size-6 fill-red-600"}),confirmCallBack:()=>c(),cancelCallBack:()=>l(!1),confirmLabel:"حذف",children:[s.jsx("p",{children:"هل أنت متأكد؟"}),s.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد إيقاف الحساب مؤقتا يمكنك إلغاء تفعيل الحساب فقط"})]})}const ze=V(function(){const{addNewOpen:a,setAddNewOpen:e,search:r}=me(),{data:o,isFetching:l,isError:c}=G({queryKey:["users",r],queryFn:async({signal:n})=>be({search:r,signal:n})}),i=(o==null?void 0:o.data)??[],d=(i==null?void 0:i.length)===0,h=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:n})=>n.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:n})=>n.getValue("is_admin")?s.jsx(ee,{className:"stroke-green-600"}):s.jsx(ue,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:n})=>{const p=n.getValue("is_admin"),f=n.getValue("is_active"),g=n.original.id;return s.jsx(qe,{disabled:p,active:f,userId:g})}},{header:"تعديل",cell:({row:n})=>{const p=n.original.id,f=n.original.is_admin;return s.jsx("div",{className:"flex items-center gap-1",children:!f&&s.jsx(Fe,{userId:p})})}}],m=i.map(n=>n.email);return s.jsxs(s.Fragment,{children:[s.jsx(Y,{isEmpty:d,isFetching:l,isError:c,children:s.jsx(te,{data:i??[],columns:h})}),s.jsx(Z,{title:"إضافة مستخدم",isOpen:a,setIsOpen:e,children:s.jsx(Se,{usersEmails:m,setIsOpen:e})})]})});export{ze as default};
