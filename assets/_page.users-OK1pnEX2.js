import{p as e,r as p,w as V}from"./chunk-PVWAREVJ-BUjujdbQ.js";import{M as z,e as Q,j as H,k as W,C as F,D as J,u as X,R as Y,F as G,l as Z}from"./Delete-Byr6iiPo.js";import{t as g,Y as q,m as ee,V as I,l as f,P as S,u as _,c as A}from"./QueryClientProvider-CfHe-Qfq.js";import{T as se}from"./Table-wojCEa9_.js";import{u as N}from"./Input-DYawAfhm.js";import{c as te,a as y,f as ae,F as re,I as C}from"./index.esm-ma4MvqKQ.js";import{L as ne,C as oe}from"./label-NZIW10D6.js";import{g as M,n as ie,d as ce,p as O,k as le,X as de}from"./PageLoader-Sek5Sb6v.js";import{P as ue}from"./index-ByP_EHTL.js";import"./query-C9xMGwXR.js";import"./button-gEZIRLgD.js";const{success:{user:{delete:me,add:pe,activate:he,deActivate:fe}}}=ee,ge=async()=>await I.from("profiles").select("*"),be=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({user_id:a})}),t=await s.json();if(!s.ok)throw g.error(q),new Error((t==null?void 0:t.error)||"Failed to delete user");return g.success(me),t},xe=async(a,r)=>{const s=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)}),t=await s.json();if(!s.ok)throw g.error(q),new Error((t==null?void 0:t.error)||"Failed to create user");return g.success(pe),t},ve=async(a,r)=>{const{error:s}=await I.from("profiles").update({is_active:a}).eq("id",r).select("");s||g.success(a?he:fe)},ye=te({email:y().email("البريد الإلكتروني غير صحيح").required(f),password:y().min(6,"يجب أن لا تقل كلمة السر عن 6 حروف").required(f),name:y().required(f),is_admin:ae().required(f),role:y().required(f).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),ke={email:"",password:"",name:"",is_admin:!1,role:""},we=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function je({setIsOpen:a}){var i,n;const r=S(),s=(n=(i=_().authData)==null?void 0:i.session)==null?void 0:n.access_token,{mutate:t,isPending:l}=N({mutationFn:c=>xe(c,s),onSuccess:()=>{a(!1),r.invalidateQueries({queryKey:["users"]})}});return e.jsx(re,{initialValues:ke,validationSchema:ye,onSubmit:c=>t(c),validateOnChange:!0,children:e.jsxs(z,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[e.jsx(C,{label:"الاسم",name:"name"}),e.jsx(Q,{label:"الوظيفة",name:"role",options:we,placeholder:"اختر الوظيفة"}),e.jsx(C,{label:"البريد الإلكتروني",name:"email"}),e.jsx(C,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),e.jsxs(ne,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[e.jsxs("span",{children:["مسؤول ","(Admin)"]}),e.jsx(oe,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var k="Switch",[Ce,$e]=ce(k),[Se,_e]=Ce(k),E=p.forwardRef((a,r)=>{const{__scopeSwitch:s,name:t,checked:l,defaultChecked:i,required:n,disabled:c,value:m="on",onCheckedChange:o,form:d,...u}=a,[h,b]=p.useState(null),w=M(r,v=>b(v)),j=p.useRef(!1),P=h?d||!!h.closest("form"):!0,[x,$]=ie({prop:l,defaultProp:i??!1,onChange:o,caller:k});return e.jsxs(Se,{scope:s,checked:x,disabled:c,children:[e.jsx(O.button,{type:"button",role:"switch","aria-checked":x,"aria-required":n,"data-state":U(x),"data-disabled":c?"":void 0,disabled:c,value:m,...u,ref:w,onClick:le(a.onClick,v=>{$(D=>!D),P&&(j.current=v.isPropagationStopped(),j.current||v.stopPropagation())})}),P&&e.jsx(R,{control:h,bubbles:!j.current,name:t,value:m,checked:x,required:n,disabled:c,form:d,style:{transform:"translateX(-100%)"}})]})});E.displayName=k;var T="SwitchThumb",B=p.forwardRef((a,r)=>{const{__scopeSwitch:s,...t}=a,l=_e(T,s);return e.jsx(O.span,{"data-state":U(l.checked),"data-disabled":l.disabled?"":void 0,...t,ref:r})});B.displayName=T;var Ne="SwitchBubbleInput",R=p.forwardRef(({__scopeSwitch:a,control:r,checked:s,bubbles:t=!0,...l},i)=>{const n=p.useRef(null),c=M(n,i),m=H(s),o=W(r);return p.useEffect(()=>{const d=n.current;if(!d)return;const u=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(u,"checked").set;if(m!==s&&b){const w=new Event("click",{bubbles:t});b.call(d,s),d.dispatchEvent(w)}},[m,s,t]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:s,...l,tabIndex:-1,ref:c,style:{...l.style,...o,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});R.displayName=Ne;function U(a){return a?"checked":"unchecked"}var K=E,Pe=B;const L=p.forwardRef(({className:a,...r},s)=>e.jsx(K,{className:A("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...r,ref:s,children:e.jsx(Pe,{className:A("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));L.displayName=K.displayName;function Ae({userId:a,active:r,disabled:s}){const t=S(),[l,i]=p.useState(!1),[n,c]=p.useState(r),{mutate:m,isPending:o}=N({mutationFn:()=>ve(n,a),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),i(!1)}}),d=n?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return e.jsxs(e.Fragment,{children:[e.jsx(L,{disabled:s,checked:n,onCheckedChange:u=>{c(u),i(!0)}}),e.jsx(F,{toggle:()=>i(u=>!u),isOpen:l,isActionsDisabled:o,title:n?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>m(),cancelCallBack:()=>{i(!1),c(u=>!u)},children:e.jsxs("p",{children:["هل أنت متأكد من ",d," ؟"]})})]})}function Fe({userId:a}){var m;const r=S(),{authData:s}=_(),t=(m=s==null?void 0:s.session)==null?void 0:m.access_token,[l,i]=p.useState(!1),{mutate:n,isPending:c}=N({mutationFn:()=>be(a,t),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),i(!1)}});return e.jsxs(F,{toggle:()=>i(o=>!o),isOpen:l,isActionsDisabled:c,title:"حذف مستخدم",trigger:e.jsx(J,{className:"size-6 fill-red-600"}),confirmCallBack:()=>n(),cancelCallBack:()=>i(!1),confirmLabel:"حذف",children:[e.jsx("p",{children:"هل أنت متأكد؟"}),e.jsx("p",{className:"text-sm text-red-500",children:"سيتم حذف كل السجلات المرتبطة بهذا المستخدم  "}),e.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد الاحتفاظ بالسجلات يمكنك إلغاء تفعيل الحساب فقط"})]})}const De=V(function(){const{addNewOpen:r,setAddNewOpen:s}=p.useContext(ue);_();const{data:t,isFetching:l,isError:i}=X({queryKey:["users"],queryFn:ge}),n=(t==null?void 0:t.data)??[],c=(n==null?void 0:n.length)===0,m=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:o})=>o.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:o})=>o.getValue("is_admin")?e.jsx(Z,{className:"stroke-green-600"}):e.jsx(de,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:o})=>{const d=o.getValue("is_admin"),u=o.getValue("is_active"),h=o.original.id;return e.jsx(Ae,{disabled:d,active:u,userId:h})}},{header:"تعديل",cell:({row:o})=>{const d=o.original.id,u=o.original.is_admin;return e.jsx("div",{className:"flex items-center gap-1",children:!u&&e.jsx(Fe,{userId:d})})}}];return e.jsxs(e.Fragment,{children:[e.jsx(Y,{isEmpty:c,isFetching:l,isError:i,children:e.jsx(se,{data:n??[],columns:m})}),e.jsx(G,{title:"إضافة مستخدم",isOpen:r,setIsOpen:s,children:e.jsx(je,{setIsOpen:s})})]})});export{De as default};
