import{p as s,r as d,w as V}from"./chunk-PVWAREVJ-DbUQBqSc.js";import{j as Q,k as H,C as P,u as W,R as J,l as X}from"./RenderData-CF_gtqvC.js";import{t as x,a3 as q,a4 as G,m as F,w as M,k as b,x as S,u as E,a2 as Y,c as N}from"./QueryClientProvider-C9MG2SoS.js";import{M as Z,S as ee,D as se,F as te}from"./Delete-BVpyM_JL.js";import{T as ae}from"./Table-C8HG5YSI.js";import{u as _}from"./input-CqFa3rKY.js";import{c as re,a as k,g as ne,F as ie}from"./index.esm-C0DY_CMF.js";import{L as oe,C as ce}from"./label-BM0Uu9Hv.js";import{I as j}from"./InputField-D-KsspTc.js";import{g as O,n as le,d as ue,p as I,k as de,X as me}from"./PageLoader-CIbqwOVp.js";import{u as pe}from"./usePageContext-Uv1FccdE.js";import"./query-CMgx36rc.js";import"./ChevronLeft-CjH0hVth.js";import"./button-cyVcpr9K.js";import"./PageContext-CC1w0XUH.js";import"./Input-CI254nul.js";const{success:{user:{delete:he,add:fe,activate:ge,deActivate:be}}}=F,xe=async({search:t,signal:a})=>{let e=M.from("profiles").select("*");return t.trim().length>0&&(e=e.ilike("name",`%${t}%`)),a&&(e=e.abortSignal(a)),await e},ve=async(t,a)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/delete-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({user_id:t})}),r=await e.json();if(!e.ok)throw x.error(q),new Error((r==null?void 0:r.error)||"Failed to delete user");return x.success(he),r},ye=async(t,a)=>{const e=await fetch("https://rhibyqyxpkcouaxhicgr.supabase.co/functions/v1/create-auth-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(t)}),r=await e.json();if(!e.ok)throw x.error(q),new G(r==null?void 0:r.error,e.status,r.code);return x.success(fe),r},ke=async(t,a)=>{const{error:e}=await M.from("profiles").update({is_active:t}).eq("id",a).select("");e||x.success(t?ge:be)},we=t=>re({email:k().email("البريد الإلكتروني غير صحيح").required(b).test({test:a=>!t.includes(a),message:F.error.user.emailExists}),password:k().min(6,"يجب أن لا تقل كلمة السر عن 6 حروف").required(b),name:k().required(b),is_admin:ne().required(b),role:k().required(b).oneOf(["nurse","doctor"],"وظيفة غير متاحة")}),Ce={email:"",password:"",name:"",is_admin:!1,role:""},je=[{label:"ممرض",value:"nurse"},{label:"طبيب",value:"doctor"}];function Se({setIsOpen:t,usersEmails:a}){var c,i;const e=S(),r=(i=(c=E().authData)==null?void 0:c.session)==null?void 0:i.access_token,{mutate:o,isPending:l}=_({mutationFn:u=>ye(u,r),onSuccess:()=>{t(!1),e.invalidateQueries({queryKey:["users"]})}});return s.jsx(ie,{initialValues:Ce,validationSchema:we(a),onSubmit:u=>o(u),validateOnChange:!0,children:s.jsxs(Z,{className:"gap-4",submitBtnLabel:"إضافة",isSubmitting:l,children:[s.jsx(j,{label:"الاسم",name:"name",autoFocus:!Y()}),s.jsx(ee,{label:"الوظيفة",name:"role",options:je,placeholder:"اختر الوظيفة"}),s.jsx(j,{label:"البريد الإلكتروني",name:"email",type:"email",inputMode:"email",autoComplete:"email",autoCapitalize:"none",spellCheck:!1}),s.jsx(j,{name:"password",label:"كلمة السر",type:"password",autoComplete:"off"}),s.jsxs(oe,{htmlFor:"is_admin",className:"mb-4 flex items-center gap-1.5",children:[s.jsxs("span",{children:["مسؤول ","(Admin)"]}),s.jsx(ce,{className:"max-sm:size-4",name:"is_admin"})]})]})})}var w="Switch",[_e,Je]=ue(w),[Ae,Ne]=_e(w),T=d.forwardRef((t,a)=>{const{__scopeSwitch:e,name:r,checked:o,defaultChecked:l,required:c,disabled:i,value:u="on",onCheckedChange:h,form:m,...n}=t,[p,f]=d.useState(null),g=O(a,y=>f(y)),C=d.useRef(!1),A=p?m||!!p.closest("form"):!0,[v,L]=le({prop:o,defaultProp:l??!1,onChange:h,caller:w});return s.jsxs(Ae,{scope:e,checked:v,disabled:i,children:[s.jsx(I.button,{type:"button",role:"switch","aria-checked":v,"aria-required":c,"data-state":K(v),"data-disabled":i?"":void 0,disabled:i,value:u,...n,ref:g,onClick:de(t.onClick,y=>{L(z=>!z),A&&(C.current=y.isPropagationStopped(),C.current||y.stopPropagation())})}),A&&s.jsx(U,{control:p,bubbles:!C.current,name:r,value:u,checked:v,required:c,disabled:i,form:m,style:{transform:"translateX(-100%)"}})]})});T.displayName=w;var B="SwitchThumb",R=d.forwardRef((t,a)=>{const{__scopeSwitch:e,...r}=t,o=Ne(B,e);return s.jsx(I.span,{"data-state":K(o.checked),"data-disabled":o.disabled?"":void 0,...r,ref:a})});R.displayName=B;var Pe="SwitchBubbleInput",U=d.forwardRef(({__scopeSwitch:t,control:a,checked:e,bubbles:r=!0,...o},l)=>{const c=d.useRef(null),i=O(c,l),u=Q(e),h=H(a);return d.useEffect(()=>{const m=c.current;if(!m)return;const n=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(n,"checked").set;if(u!==e&&f){const g=new Event("click",{bubbles:r});f.call(m,e),m.dispatchEvent(g)}},[u,e,r]),s.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:e,...o,tabIndex:-1,ref:i,style:{...o.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});U.displayName=Pe;function K(t){return t?"checked":"unchecked"}var $=T,qe=R;const D=d.forwardRef(({className:t,...a},e)=>s.jsx($,{className:N("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",t),...a,ref:e,children:s.jsx(qe,{className:N("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=unchecked]:translate-x-0 ltr:data-[state=checked]:translate-x-5 rtl:data-[state=checked]:-translate-x-5")})}));D.displayName=$.displayName;function Fe({userId:t,active:a,disabled:e}){const r=S(),[o,l]=d.useState(!1),[c,i]=d.useState(a),{mutate:u,isPending:h}=_({mutationFn:()=>ke(c,t),onSuccess:()=>{r.invalidateQueries({queryKey:["users"]}),l(!1)}}),m=c?"تفعيل المستخدم":"إلغاء تفعيل المستخدم";return s.jsxs(s.Fragment,{children:[s.jsx(D,{disabled:e,checked:c,onCheckedChange:n=>{i(n),l(!0)}}),s.jsx(P,{toggle:()=>l(n=>!n),isOpen:o,isActionsDisabled:h,title:c?"تفعيل مستخدم":"إلغاء تفعيل مستخدم",confirmCallBack:()=>u(),cancelCallBack:()=>{l(!1),i(n=>!n)},children:s.jsxs("p",{children:["هل أنت متأكد من ",m," ؟"]})})]})}function Me({userId:t}){var u;const a=S(),{authData:e}=E(),r=(u=e==null?void 0:e.session)==null?void 0:u.access_token,[o,l]=d.useState(!1),{mutate:c,isPending:i}=_({mutationFn:()=>ve(t,r),onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),l(!1)}});return s.jsxs(P,{toggle:()=>l(h=>!h),isOpen:o,isActionsDisabled:i,title:"حذف مستخدم",trigger:s.jsx(se,{className:"size-6 fill-red-600"}),confirmCallBack:()=>c(),cancelCallBack:()=>l(!1),confirmLabel:"حذف",children:[s.jsx("p",{children:"هل أنت متأكد؟"}),s.jsx("p",{className:"font-medium text-primary",children:"اذا كنت تريد إيقاف الحساب مؤقتا يمكنك إلغاء تفعيل الحساب فقط"})]})}const Xe=V(function(){const{addNewOpen:a,setAddNewOpen:e,search:r}=pe(),{data:o,isFetching:l,isError:c}=W({queryKey:["users",r],queryFn:async({signal:n})=>xe({search:r,signal:n})}),i=(o==null?void 0:o.data)??[],u=(i==null?void 0:i.length)===0,h=[{accessorKey:"email",header:"البريد الإلكتروني"},{accessorKey:"name",header:"الاسم"},{accessorKey:"role",header:"الوظيفة",cell:({row:n})=>n.getValue("role")==="doctor"?"طبيب":"ممرض"},{accessorKey:"is_admin",header:"مسؤول",cell:({row:n})=>n.getValue("is_admin")?s.jsx(X,{className:"stroke-green-600"}):s.jsx(me,{className:"fill-red-600"})},{accessorKey:"is_active",header:"تفعيل",cell:({row:n})=>{const p=n.getValue("is_admin"),f=n.getValue("is_active"),g=n.original.id;return s.jsx(Fe,{disabled:p,active:f,userId:g})}},{header:"تعديل",cell:({row:n})=>{const p=n.original.id,f=n.original.is_admin;return s.jsx("div",{className:"flex items-center gap-1",children:!f&&s.jsx(Me,{userId:p})})}}],m=i.map(n=>n.email);return s.jsxs(s.Fragment,{children:[s.jsx(J,{isEmpty:u,isFetching:l,isError:c,children:s.jsx(ae,{data:i??[],columns:h})}),s.jsx(te,{title:"إضافة مستخدم",isOpen:a,setIsOpen:e,children:s.jsx(Se,{usersEmails:m,setIsOpen:e})})]})});export{Xe as default};
